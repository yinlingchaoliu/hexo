<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="引领潮流">
<meta property="og:url" content="http://yoursite.com/page/33/index.html">
<meta property="og:site_name" content="引领潮流">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="引领潮流">



  <link rel="alternate" href="/atom.xml" title="引领潮流" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://yoursite.com/page/33/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>引领潮流</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">引领潮流</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Android相关/Android设置公共请求头head-query-param/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Android相关/Android设置公共请求头head-query-param/" class="post-title-link" itemprop="url">Android设置公共请求头head-query-param</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android相关/" itemprop="url" rel="index"><span itemprop="name">Android相关</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原理：通过okhttp intercept<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author chentong</span><br><span class="line"> * @date 2019-2-20</span><br><span class="line"> * 设置公共参数</span><br><span class="line"> * head params query</span><br><span class="line"> */</span><br><span class="line">public class HttpBaseParamsInterceptor implements Interceptor &#123;</span><br><span class="line"></span><br><span class="line">    private Map&lt;String, String&gt; queryParamsMap = new HashMap&lt;&gt;();</span><br><span class="line">    private Map&lt;String, String&gt; paramsMap = new HashMap&lt;&gt;();</span><br><span class="line">    private Map&lt;String, String&gt; headerParamsMap = new HashMap&lt;&gt;();</span><br><span class="line">    private List&lt;String&gt; headerLinesList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private static final String X_WWW_FORM_URLENCODED = &quot;x-www-form-urlencoded&quot;;</span><br><span class="line">    private Builder builder;</span><br><span class="line">    private UpdateHandler updateHandler;</span><br><span class="line"></span><br><span class="line">    public HttpBaseParamsInterceptor() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Response intercept(Chain chain) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        //每次获取公共数据</span><br><span class="line">        if (updateHandler != null) &#123;</span><br><span class="line">            builder = updateHandler.createNewBuilder();</span><br><span class="line">            reloadBuilder( builder );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Request request = chain.request();</span><br><span class="line">        Request.Builder requestBuilder = request.newBuilder();</span><br><span class="line"></span><br><span class="line">        // 设置header</span><br><span class="line">        Headers.Builder headerBuilder = request.headers().newBuilder();</span><br><span class="line">        if (headerParamsMap.size() &gt; 0) &#123;</span><br><span class="line">            Iterator iterator = headerParamsMap.entrySet().iterator();</span><br><span class="line">            while (iterator.hasNext()) &#123;</span><br><span class="line">                Map.Entry entry = (Map.Entry) iterator.next();</span><br><span class="line">                headerBuilder.add( (String) entry.getKey(), (String) entry.getValue() );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (headerLinesList.size() &gt; 0) &#123;</span><br><span class="line">            for (String line : headerLinesList) &#123;</span><br><span class="line">                headerBuilder.add( line );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        requestBuilder.headers( headerBuilder.build() );</span><br><span class="line"></span><br><span class="line">        // process queryParams inject whatever it&apos;s GET or POST</span><br><span class="line">        if (queryParamsMap.size() &gt; 0) &#123;</span><br><span class="line">            injectParamsIntoUrl( request, requestBuilder, queryParamsMap );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // process header params end</span><br><span class="line">        //设置param</span><br><span class="line">        //请求体 可以为空</span><br><span class="line">        RequestBody requestBody = request.body();</span><br><span class="line">        boolean hasRequestBody = requestBody != null;</span><br><span class="line"></span><br><span class="line">        String contentType = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        if (hasRequestBody) &#123;</span><br><span class="line">            //contentType存在空</span><br><span class="line">            if (requestBody.contentType() != null) &#123;</span><br><span class="line">                contentType = requestBody.contentType().toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (request.method().equals( &quot;POST&quot; ) &amp;&amp; contentType.contains( X_WWW_FORM_URLENCODED )) &#123;</span><br><span class="line">            FormBody.Builder formBodyBuilder = new FormBody.Builder();</span><br><span class="line">            if (paramsMap.size() &gt; 0) &#123;</span><br><span class="line">                Iterator iterator = paramsMap.entrySet().iterator();</span><br><span class="line">                while (iterator.hasNext()) &#123;</span><br><span class="line">                    Map.Entry entry = (Map.Entry) iterator.next();</span><br><span class="line">                    formBodyBuilder.add( (String) entry.getKey(), (String) entry.getValue() );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            RequestBody formBody = formBodyBuilder.build();</span><br><span class="line">            String formBodyString = bodyToString( formBody );</span><br><span class="line">            String requestBodyString = bodyToString( requestBody );</span><br><span class="line">            String postBodyString = &quot;&quot;;</span><br><span class="line">            if (!TextUtils.isEmpty( requestBodyString ) &amp;&amp; !TextUtils.isEmpty( formBodyString )) &#123;</span><br><span class="line">                postBodyString = requestBodyString + &quot;&amp;&quot; + formBodyString;</span><br><span class="line">            &#125; else if (!TextUtils.isEmpty( requestBodyString ) || TextUtils.isEmpty( formBodyString )) &#123;</span><br><span class="line">                postBodyString = requestBodyString;</span><br><span class="line">            &#125; else if (TextUtils.isEmpty( requestBodyString ) &amp;&amp; !TextUtils.isEmpty( formBodyString )) &#123;</span><br><span class="line">                postBodyString = formBodyString;</span><br><span class="line">            &#125; else if (TextUtils.isEmpty( requestBodyString ) &amp;&amp; TextUtils.isEmpty( formBodyString )) &#123;</span><br><span class="line">                postBodyString = &quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            requestBuilder.post( RequestBody.create( MediaType.parse( &quot;application/x-www-form-urlencoded;charset=UTF-8&quot; ), postBodyString ) );</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            injectParamsIntoUrl( request, requestBuilder, paramsMap );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request = requestBuilder.build();</span><br><span class="line">        return chain.proceed( request );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // func to inject params into url</span><br><span class="line">    private void injectParamsIntoUrl(Request request, Request.Builder requestBuilder, Map&lt;String, String&gt; paramsMap) &#123;</span><br><span class="line">        HttpUrl.Builder httpUrlBuilder = request.url().newBuilder();</span><br><span class="line">        if (paramsMap.size() &gt; 0) &#123;</span><br><span class="line">            Iterator iterator = paramsMap.entrySet().iterator();</span><br><span class="line">            while (iterator.hasNext()) &#123;</span><br><span class="line">                Map.Entry entry = (Map.Entry) iterator.next();</span><br><span class="line">                httpUrlBuilder.addQueryParameter( (String) entry.getKey(), (String) entry.getValue() );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        requestBuilder.url( httpUrlBuilder.build() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String bodyToString(final RequestBody requestBody) &#123;</span><br><span class="line">        if (requestBody == null) return &quot;&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            Buffer buffer = new Buffer();</span><br><span class="line">            requestBody.writeTo( buffer );</span><br><span class="line">            return buffer.readUtf8();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 设置刷新句柄</span><br><span class="line">     * @param updateHandler</span><br><span class="line">     */</span><br><span class="line">    public void setUpdateHandler(UpdateHandler updateHandler) &#123;</span><br><span class="line">        this.updateHandler = updateHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface UpdateHandler &#123;</span><br><span class="line">        Builder createNewBuilder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 重新加载数据</span><br><span class="line">     * @param builder</span><br><span class="line">     */</span><br><span class="line">    private void reloadBuilder(Builder builder) &#123;</span><br><span class="line">        queryParamsMap.clear();</span><br><span class="line">        paramsMap.clear();</span><br><span class="line">        headerParamsMap.clear();</span><br><span class="line">        headerLinesList.clear();</span><br><span class="line"></span><br><span class="line">        queryParamsMap.putAll( builder.queryParamsMap );</span><br><span class="line">        paramsMap.putAll( builder.paramsMap );</span><br><span class="line">        headerParamsMap.putAll( builder.headerParamsMap );</span><br><span class="line">        headerLinesList.addAll( builder.headerLinesList );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 数据要刷新</span><br><span class="line">     */</span><br><span class="line">    public static class Builder &#123;</span><br><span class="line"></span><br><span class="line">        private Map&lt;String, String&gt; queryParamsMap = new HashMap&lt;&gt;();</span><br><span class="line">        private Map&lt;String, String&gt; paramsMap = new HashMap&lt;&gt;();</span><br><span class="line">        private Map&lt;String, String&gt; headerParamsMap = new HashMap&lt;&gt;();</span><br><span class="line">        private List&lt;String&gt; headerLinesList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        public Builder() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addParam(String key, String value) &#123;</span><br><span class="line">            paramsMap.put( key, value );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addParamsMap(Map&lt;String, String&gt; paramsMap) &#123;</span><br><span class="line">            paramsMap.putAll( paramsMap );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addHeaderParam(String key, String value) &#123;</span><br><span class="line">            headerParamsMap.put( key, value );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addHeaderParamsMap(Map&lt;String, String&gt; headerParamsMap) &#123;</span><br><span class="line">            headerParamsMap.putAll( headerParamsMap );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addHeaderLine(String headerLine) &#123;</span><br><span class="line">            int index = headerLine.indexOf( &quot;:&quot; );</span><br><span class="line">            if (index == -1) &#123;</span><br><span class="line">                throw new IllegalArgumentException( &quot;Unexpected header: &quot; + headerLine );</span><br><span class="line">            &#125;</span><br><span class="line">            headerLinesList.add( headerLine );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addHeaderLinesList(List&lt;String&gt; headerLinesList) &#123;</span><br><span class="line">            for (String headerLine : headerLinesList) &#123;</span><br><span class="line">                int index = headerLine.indexOf( &quot;:&quot; );</span><br><span class="line">                if (index == -1) &#123;</span><br><span class="line">                    throw new IllegalArgumentException( &quot;Unexpected header: &quot; + headerLine );</span><br><span class="line">                &#125;</span><br><span class="line">                headerLinesList.add( headerLine );</span><br><span class="line">            &#125;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addQueryParam(String key, String value) &#123;</span><br><span class="line">            queryParamsMap.put( key, value );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder addQueryParamsMap(Map&lt;String, String&gt; queryParamsMap) &#123;</span><br><span class="line">            queryParamsMap.putAll( queryParamsMap );</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder build() &#123;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 设置http公共参数</span><br><span class="line"> * head query param</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private HttpBaseParamsInterceptor getBaseParams()&#123;</span><br><span class="line">    HttpBaseParamsInterceptor interceptor = new HttpBaseParamsInterceptor();</span><br><span class="line">    interceptor.setUpdateHandler( () -&gt; &#123;</span><br><span class="line">        //设置公共参数</span><br><span class="line">        String versionCode =AppUtlis.getVersionCode(MyApplication.getInstance() ).toString();</span><br><span class="line">        String userId = SharePreferenceUtill.getStringData(ContansUtils.USERID_KEY, &quot;&quot;);</span><br><span class="line">        HttpBaseParamsInterceptor.Builder  builder = new HttpBaseParamsInterceptor.Builder()</span><br><span class="line">                .addParam( ContansUtils.USERID_KEY,userId )</span><br><span class="line">                .addParam(&quot;versionCode&quot;,versionCode).build();</span><br><span class="line">        return builder;</span><br><span class="line">    &#125; );</span><br><span class="line"></span><br><span class="line">    return interceptor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Android相关/ConstraintLayout实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Android相关/ConstraintLayout实战/" class="post-title-link" itemprop="url">ConstraintLayout实战</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android相关/" itemprop="url" rel="index"><span itemprop="name">Android相关</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h6 id="1、自动添加约束-不推荐"><a href="#1、自动添加约束-不推荐" class="headerlink" title="1、自动添加约束(不推荐)"></a>1、自动添加约束(不推荐)</h6><ul>
<li>Autoconnect 针对单个控件<br><img src="https://upload-images.jianshu.io/upload_images/5526061-17c342b453d094e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
<li>Inference 针对整个布局<br><img src="https://upload-images.jianshu.io/upload_images/5526061-4858476574452cc4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></li>
</ul>
<p>点击一下即可，推荐Inference</p>
<h6 id="二、手工写约束"><a href="#二、手工写约束" class="headerlink" title="二、手工写约束"></a>二、手工写约束</h6><p>1、相对位置<br><img src="https://upload-images.jianshu.io/upload_images/5526061-4be7f845416d2e59.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;android.support.constraint.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ImageView</span><br><span class="line">        android:id=&quot;@+id/logoIv&quot;</span><br><span class="line">        android:layout_width=&quot;140dp&quot;</span><br><span class="line">        android:layout_height=&quot;86dp&quot;</span><br><span class="line">        android:layout_marginStart=&quot;12dp&quot;</span><br><span class="line">        android:layout_marginLeft=&quot;12dp&quot;</span><br><span class="line">        android:layout_marginTop=&quot;12dp&quot;</span><br><span class="line">        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintTop_toTopOf=&quot;parent&quot;</span><br><span class="line">        app:srcCompat=&quot;@color/colorAccent&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/infoTv&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_marginLeft=&quot;8dp&quot;</span><br><span class="line">        android:layout_marginTop=&quot;12dp&quot;</span><br><span class="line">        android:layout_marginRight=&quot;12dp&quot;</span><br><span class="line">        android:text=&quot;马云:一年交税170多亿马云:一年交税170多亿马云:一年交税170多亿&quot;</span><br><span class="line">        android:textColor=&quot;#000000&quot;</span><br><span class="line">        android:textSize=&quot;16dp&quot;</span><br><span class="line">        app:layout_constraintLeft_toRightOf=&quot;@id/logoIv&quot;</span><br><span class="line">        app:layout_constraintRight_toRightOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_marginStart=&quot;8dp&quot;</span><br><span class="line">        android:layout_marginLeft=&quot;8dp&quot;</span><br><span class="line">        android:text=&quot;8分钟前&quot;</span><br><span class="line">        android:textColor=&quot;#333&quot;</span><br><span class="line">        android:textSize=&quot;12dp&quot;</span><br><span class="line">        app:layout_constraintBottom_toBottomOf=&quot;@id/logoIv&quot;</span><br><span class="line">        app:layout_constraintLeft_toRightOf=&quot;@id/logoIv&quot;</span><br><span class="line">        app:layout_constraintTop_toBottomOf=&quot;@id/infoTv&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure>
<p>手敲一遍，感受一下。<br>总结一句口诀<br><code>先写margin ,
后写constraint, 
to是相对控件起始位置</code><br>eg:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//左边距是8dp</span><br><span class="line">android:layout_marginLeft=&quot;8dp&quot;</span><br><span class="line">//左边距在logoIv右侧开始</span><br><span class="line">app:layout_constraintLeft_toRightOf=&quot;@id/logoIv&quot;</span><br></pre></td></tr></table></figure></p>
<p>2 、match失效<br>用“0dp”代替<br>ConstraintLayout中0代表：MATCH_CONSTRAINT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout</span><br><span class="line">       android:layout_width=&quot;match_parent&quot;</span><br><span class="line">       android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">       android:layout_marginTop=&quot;12dp&quot;</span><br><span class="line">       android:background=&quot;@color/colorPrimary&quot;&gt;</span><br><span class="line"></span><br><span class="line">       &lt;Button</span><br><span class="line">           android:id=&quot;@+id/btn01&quot;</span><br><span class="line">           android:layout_width=&quot;100dp&quot;</span><br><span class="line">           android:layout_height=&quot;40dp&quot; /&gt;</span><br><span class="line"></span><br><span class="line">       &lt;Button</span><br><span class="line">           android:id=&quot;@+id/btn02&quot;</span><br><span class="line">           android:layout_width=&quot;0dp&quot;</span><br><span class="line">           android:layout_height=&quot;40dp&quot;</span><br><span class="line">           android:layout_marginStart=&quot;12dp&quot;</span><br><span class="line">           android:layout_marginLeft=&quot;12dp&quot;</span><br><span class="line">           app:layout_constraintLeft_toRightOf=&quot;@id/btn01&quot;</span><br><span class="line">           app:layout_constraintRight_toRightOf=&quot;parent&quot;/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;/android.support.constraint.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure>
<p>3、设置宽高比<br>第一种写法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout</span><br><span class="line">    android:id=&quot;@+id/layout0&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;0dp&quot;</span><br><span class="line">        android:background=&quot;#765&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Banner&quot;</span><br><span class="line">        app:layout_constraintDimensionRatio=&quot;H,16:6&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>第二种写法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout</span><br><span class="line">    android:layout_marginTop=&quot;12dp&quot;</span><br><span class="line">    app:layout_constraintTop_toBottomOf=&quot;@id/layout2&quot;</span><br><span class="line">    android:id=&quot;@+id/layout3&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;0dp&quot;</span><br><span class="line">        android:background=&quot;#765&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Banner&quot;</span><br><span class="line">        app:layout_constraintTop_toTopOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintRight_toRightOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintDimensionRatio=&quot;H,5:1&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//宽高比设置</span><br><span class="line">app:layout_constraintDimensionRatio=&quot;W,16:6&quot;</span><br><span class="line">app:layout_constraintDimensionRatio=&quot;H,16:6&quot;</span><br></pre></td></tr></table></figure>
<p>4、设置权重<br>第一种写法</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5526061-fa3d92fb4d497bad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">    app:layout_constraintBottom_toBottomOf=&quot;parent&quot;</span><br><span class="line">    app:layout_constraintBottom_toTopOf=&quot;@id/layout3&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tab01&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;30dp&quot;</span><br><span class="line">        android:background=&quot;#f67&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Tab1&quot;</span><br><span class="line">        app:layout_constraintHorizontal_weight=&quot;2&quot;</span><br><span class="line">        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintRight_toLeftOf=&quot;@id/tab02&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tab02&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;30dp&quot;</span><br><span class="line">        android:background=&quot;#A67&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Tab2&quot;</span><br><span class="line">        app:layout_constraintHorizontal_weight=&quot;1&quot;</span><br><span class="line">        app:layout_constraintLeft_toRightOf=&quot;@id/tab01&quot;</span><br><span class="line">        app:layout_constraintRight_toLeftOf=&quot;@id/tab03&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tab03&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;30dp&quot;</span><br><span class="line">        android:background=&quot;#767&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Tab3&quot;</span><br><span class="line">        app:layout_constraintHorizontal_weight=&quot;1&quot;</span><br><span class="line">        app:layout_constraintLeft_toRightOf=&quot;@id/tab02&quot;</span><br><span class="line">        app:layout_constraintRight_toRightOf=&quot;parent&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure>
<p>第二种写法<br><img src="https://upload-images.jianshu.io/upload_images/5526061-5af144f4c7f29a8b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">    app:layout_constraintBottom_toBottomOf=&quot;parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tab1&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;30dp&quot;</span><br><span class="line">        android:background=&quot;#f67&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Tab1&quot;</span><br><span class="line">        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;</span><br><span class="line">        app:layout_constraintRight_toLeftOf=&quot;@id/tab2&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tab2&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;30dp&quot;</span><br><span class="line">        android:background=&quot;#A67&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:text=&quot;Tab2&quot;</span><br><span class="line">        app:layout_constraintLeft_toRightOf=&quot;@id/tab1&quot;</span><br><span class="line">        app:layout_constraintRight_toLeftOf=&quot;@id/tab3&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tab3&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;30dp&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:background=&quot;#767&quot;</span><br><span class="line">        android:text=&quot;Tab3&quot;</span><br><span class="line">        app:layout_constraintLeft_toRightOf=&quot;@id/tab2&quot;</span><br><span class="line">        app:layout_constraintRight_toRightOf=&quot;parent&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app:layout_constraintHorizontal_weight</span><br><span class="line">app:layout_constraintVertical_weight</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app:layout_constraintHorizontal_chainStyle=&quot;spread&quot;</span><br><span class="line">//配合宽度非0dp</span><br></pre></td></tr></table></figure>
<p>5、浮动按钮</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">    android:layout_width=&quot;60dp&quot;</span><br><span class="line">    android:layout_height=&quot;60dp&quot;</span><br><span class="line">    android:background=&quot;#612&quot;</span><br><span class="line">    app:layout_constraintHorizontal_bias=&quot;0.9&quot;</span><br><span class="line">    app:layout_constraintVertical_bias=&quot;0.9&quot;</span><br><span class="line">    app:layout_constraintBottom_toBottomOf=&quot;parent&quot;</span><br><span class="line">    app:layout_constraintLeft_toLeftOf=&quot;parent&quot;</span><br><span class="line">    app:layout_constraintRight_toRightOf=&quot;parent&quot;</span><br><span class="line">    app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//两侧间隙比例</span><br><span class="line">layout_constraintHorizontal_bias</span><br><span class="line">layout_constraintVertical_bias</span><br></pre></td></tr></table></figure>
<p>Guideline</p>
<p>####演示代码<br><a href="https://github.com/yinlingchaoliu/ConstraintLayoutDemo" target="_blank" rel="noopener">https://github.com/yinlingchaoliu/ConstraintLayoutDemo</a></p>
<p><img src="https://upload-images.jianshu.io/upload_images/5526061-b11545851fe1a74b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo效果"></p>
<p>####参考<br><a href="http://blog.csdn.net/lmj623565791/article/details/78011599" target="_blank" rel="noopener">http://blog.csdn.net/lmj623565791/article/details/78011599</a><br>本文出自<a href="http://blog.csdn.net/lmj623565791/" target="_blank" rel="noopener">张鸿洋的博客</a></p>
<p><a href="http://blog.csdn.net/guolin_blog/article/details/53122387" target="_blank" rel="noopener">Android新特性介绍，ConstraintLayout完全解析</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Android相关/flutter解决布局嵌套问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Android相关/flutter解决布局嵌套问题/" class="post-title-link" itemprop="url">flutter解决布局嵌套问题</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android相关/" itemprop="url" rel="index"><span itemprop="name">Android相关</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>思路：flutter的布局嵌套层次太多，改成链式调用会简单一些</p>
<p>原来的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import &apos;package:flutter/material.dart&apos;;</span><br><span class="line">import &apos;package:flutter_easy/common/util/common.dart&apos;;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">  runApp(</span><br><span class="line">    new MaterialApp(</span><br><span class="line">      title: &apos;&apos;,</span><br><span class="line">      theme: new ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: new TestPage(),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">///author:chentong</span><br><span class="line">///date:4/10/19</span><br><span class="line">class TestPage extends StatelessWidget &#123;</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return new Scaffold(</span><br><span class="line">      appBar: new AppBar(</span><br><span class="line">        title: new Text(&apos;demo&apos;),</span><br><span class="line">      ),</span><br><span class="line">      body: new Align(</span><br><span class="line">          alignment: FractionalOffset.centerRight,</span><br><span class="line">          child: new Padding(</span><br><span class="line">              padding: CommonUtil.padding(left: 10), child: new Text(&quot;我是测试党&quot;))),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>假如再加上click事件，那么简直是太TMD的了</p>
<p><code>设计模式中有建造者模式，可以用链式调用，解决多层嵌套问题</code></p>
<p>调用如下，我还特意加上click事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WidgetDecoration(new Text(&quot;我是测试党&quot;))</span><br><span class="line">          .padding(left: 10)</span><br><span class="line">          .align(alignment: FractionalOffset.centerRight)</span><br><span class="line">          .onTap(()&#123;</span><br><span class="line">            Fluttertoast.showToast(msg: &quot;你看我还能点击呢!&quot;)</span><br><span class="line">      &#125;).build(),</span><br></pre></td></tr></table></figure></p>
<p><code>这样写法你说优秀不优秀</code><br>不用担心括号一层一层的问题</p>
<p>完整建造者代码，已应用于项目<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">import &apos;package:flutter/material.dart&apos;;</span><br><span class="line"></span><br><span class="line">///widget装饰器</span><br><span class="line">///</span><br><span class="line">/// author:chentong</span><br><span class="line">/// 层级调用改为链式调用，方便查看</span><br><span class="line">/// 4/11/19</span><br><span class="line">///</span><br><span class="line">class WidgetDecoration &#123;</span><br><span class="line">  Widget _widget;</span><br><span class="line"></span><br><span class="line">  WidgetDecoration(Widget widget) &#123;</span><br><span class="line">    this._widget = widget;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Function _onTapFunc;</span><br><span class="line">  Function _onDoubleTapFunc;</span><br><span class="line">  Function _onLongPressFunc;</span><br><span class="line"></span><br><span class="line">  ///add padding属性</span><br><span class="line">  WidgetDecoration padding(</span><br><span class="line">      &#123;Key key, double left = 0.0, double top = 0.0, double right = 0.0, double bottom = 0.0&#125;) &#123;</span><br><span class="line">    var padding = EdgeInsets.only(left: left, top: top, right: right, bottom: bottom);</span><br><span class="line">    _widget = new Padding(key: key, padding: padding, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///增加padingall</span><br><span class="line">  WidgetDecoration paddAll(&#123;Key key, double all = 0.0&#125;) &#123;</span><br><span class="line">    var padding = EdgeInsets.all(all);</span><br><span class="line">    _widget = new Padding(key: key, padding: padding, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///增加align 当前布局相对位置</span><br><span class="line">  ///FractionalOffset.centerRight</span><br><span class="line">  WidgetDecoration align(&#123;Key key, AlignmentGeometry alignment = Alignment.center&#125;) &#123;</span><br><span class="line">    _widget = new Align(key: key, alignment: alignment, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///位置</span><br><span class="line">  WidgetDecoration positioned(</span><br><span class="line">      &#123;Key key,</span><br><span class="line">      double left,</span><br><span class="line">      double top,</span><br><span class="line">      double right,</span><br><span class="line">      double bottom,</span><br><span class="line">      double width,</span><br><span class="line">      double height&#125;) &#123;</span><br><span class="line">    _widget = new Positioned(</span><br><span class="line">        key: key,</span><br><span class="line">        left: left,</span><br><span class="line">        top: top,</span><br><span class="line">        right: right,</span><br><span class="line">        bottom: bottom,</span><br><span class="line">        width: width,</span><br><span class="line">        height: height,</span><br><span class="line">        child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///stack 相当于frameLayout布局</span><br><span class="line"></span><br><span class="line">  ///填充布局</span><br><span class="line">  WidgetDecoration expanded(&#123;Key key, int flex = 1&#125;) &#123;</span><br><span class="line">    _widget = new Expanded(key: key, flex: flex, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///是否显示布局 true为不显示 false为显示</span><br><span class="line">  WidgetDecoration offstage(&#123;Key key, bool offstage = true&#125;) &#123;</span><br><span class="line">    _widget = new Offstage(key: key, offstage: offstage, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///透明度 0 是完全透明 1 完全不透明</span><br><span class="line">  WidgetDecoration opacity(&#123;Key key, @required double opacity, alwaysIncludeSemantics = false&#125;) &#123;</span><br><span class="line">    _widget = new Opacity(</span><br><span class="line">        key: key, opacity: opacity, alwaysIncludeSemantics: alwaysIncludeSemantics, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///基准线布局</span><br><span class="line">  WidgetDecoration baseline(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    @required double baseline,</span><br><span class="line">    @required TextBaseline baselineType,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget =</span><br><span class="line">        new Baseline(key: key, baseline: baseline, baselineType: baselineType, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///设置宽高比</span><br><span class="line">  WidgetDecoration aspectRatio(&#123;Key key, @required double aspectRatio&#125;) &#123;</span><br><span class="line">    _widget = new AspectRatio(key: key, aspectRatio: aspectRatio, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///矩阵转换</span><br><span class="line">  WidgetDecoration transform(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    @required Matrix4 transform,</span><br><span class="line">    origin,</span><br><span class="line">    alignment,</span><br><span class="line">    transformHitTests = true,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget = new Transform(</span><br><span class="line">        key: key,</span><br><span class="line">        transform: transform,</span><br><span class="line">        origin: origin,</span><br><span class="line">        alignment: alignment,</span><br><span class="line">        transformHitTests: transformHitTests,</span><br><span class="line">        child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///居中 todo: center</span><br><span class="line">  WidgetDecoration center(&#123;Key key, double widthFactor, double heightFactor&#125;) &#123;</span><br><span class="line">    _widget =</span><br><span class="line">        new Center(key: key, widthFactor: widthFactor, heightFactor: heightFactor, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///布局容器</span><br><span class="line">  WidgetDecoration container(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    alignment,</span><br><span class="line">    padding,</span><br><span class="line">    Color color,</span><br><span class="line">    Decoration decoration,</span><br><span class="line">    foregroundDecoration,</span><br><span class="line">    double width,</span><br><span class="line">    double height,</span><br><span class="line">    BoxConstraints constraints,</span><br><span class="line">    margin,</span><br><span class="line">    transform,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget = new Container(</span><br><span class="line">        key: key,</span><br><span class="line">        alignment: alignment,</span><br><span class="line">        padding: padding,</span><br><span class="line">        color: color,</span><br><span class="line">        decoration: decoration,</span><br><span class="line">        foregroundDecoration: foregroundDecoration,</span><br><span class="line">        width: width,</span><br><span class="line">        height: height,</span><br><span class="line">        constraints: constraints,</span><br><span class="line">        margin: margin,</span><br><span class="line">        transform: transform,</span><br><span class="line">        child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///设置具体尺寸</span><br><span class="line">  WidgetDecoration sizedBox(&#123;Key key, double width, double height&#125;) &#123;</span><br><span class="line">    _widget = new SizedBox(key: key, width: width, height: height, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///设置最大最小宽高布局</span><br><span class="line">  WidgetDecoration constrainedBox(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    minWidth = 0.0,</span><br><span class="line">    maxWidth = double.infinity,</span><br><span class="line">    minHeight = 0.0,</span><br><span class="line">    maxHeight = double.infinity,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    BoxConstraints constraints = new BoxConstraints(</span><br><span class="line">        minWidth: minWidth, maxWidth: maxWidth, minHeight: minHeight, maxHeight: maxHeight);</span><br><span class="line">    _widget = new ConstrainedBox(key: key, constraints: constraints, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///限定最大宽高布局</span><br><span class="line">  WidgetDecoration limitedBox(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    maxWidth = double.infinity,</span><br><span class="line">    maxHeight = double.infinity,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget = new LimitedBox(key: key, maxWidth: maxWidth, maxHeight: maxHeight, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///百分比布局</span><br><span class="line">  WidgetDecoration fractionallySizedBox(</span><br><span class="line">      &#123;Key key, alignment = Alignment.center, double widthFactor, double heightFactor&#125;) &#123;</span><br><span class="line">    _widget = new FractionallySizedBox(</span><br><span class="line">        key: key,</span><br><span class="line">        alignment: alignment,</span><br><span class="line">        widthFactor: widthFactor,</span><br><span class="line">        heightFactor: heightFactor,</span><br><span class="line">        child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///缩放布局</span><br><span class="line">  WidgetDecoration fittedBox(&#123;Key key, fit = BoxFit.contain, alignment = Alignment.center&#125;) &#123;</span><br><span class="line">    _widget = new FittedBox(key: key, fit: fit, alignment: alignment, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///旋转盒子 1次是90度</span><br><span class="line">  WidgetDecoration rotatedBox(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    @required int quarterTurns,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget = new RotatedBox(key: key, quarterTurns: quarterTurns, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///装饰盒子 细节往外抛 decoration 编写放在外面</span><br><span class="line">  WidgetDecoration decoratedBox(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    @required Decoration decoration,</span><br><span class="line">    position = DecorationPosition.background,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget =</span><br><span class="line">        new DecoratedBox(key: key, decoration: decoration, position: position, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///圆形剪裁</span><br><span class="line">  WidgetDecoration clipOval(</span><br><span class="line">      &#123;Key key, CustomClipper&lt;Rect&gt; clipper, Clip clipBehavior = Clip.antiAlias&#125;) &#123;</span><br><span class="line">    _widget = new ClipOval(key: key, clipper: clipper, clipBehavior: clipBehavior, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///圆角矩形剪裁</span><br><span class="line">  WidgetDecoration clipRRect(</span><br><span class="line">      &#123;Key key,</span><br><span class="line">      @required BorderRadius borderRadius,</span><br><span class="line">      CustomClipper&lt;RRect&gt; clipper,</span><br><span class="line">      Clip clipBehavior = Clip.antiAlias&#125;) &#123;</span><br><span class="line">    _widget = new ClipRRect(</span><br><span class="line">        key: key,</span><br><span class="line">        borderRadius: borderRadius,</span><br><span class="line">        clipper: clipper,</span><br><span class="line">        clipBehavior: clipBehavior,</span><br><span class="line">        child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///矩形剪裁  todo: 需要自定义clipper 否则无效果</span><br><span class="line">  WidgetDecoration clipRect(</span><br><span class="line">      &#123;Key key, @required CustomClipper&lt;Rect&gt; clipper, Clip clipBehavior = Clip.hardEdge&#125;) &#123;</span><br><span class="line">    _widget = new ClipRect(key: key, clipper: clipper, clipBehavior: clipBehavior, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///路径剪裁  todo: 需要自定义clipper 否则无效果</span><br><span class="line">  WidgetDecoration clipPath(</span><br><span class="line">      &#123;Key key, @required CustomClipper&lt;Path&gt; clipper, Clip clipBehavior = Clip.antiAlias&#125;) &#123;</span><br><span class="line">    _widget = new ClipPath(key: key, clipper: clipper, clipBehavior: clipBehavior, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///animatedOpacity 淡入淡出</span><br><span class="line">  WidgetDecoration animatedOpacity(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    @required double opacity,</span><br><span class="line">    Curve curve = Curves.linear,</span><br><span class="line">    @required Duration duration,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    _widget = new AnimatedOpacity(</span><br><span class="line">        key: key, opacity: opacity, curve: curve, duration: duration, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///页面简单切换效果</span><br><span class="line">  WidgetDecoration hero(&#123;Key key, @required Object tag&#125;) &#123;</span><br><span class="line">    _widget = new Hero(key: key, tag: tag, child: _widget);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///点击事件</span><br><span class="line">  WidgetDecoration onClick(&#123;Key key, onTap, onDoubleTap, onLongPress&#125;) &#123;</span><br><span class="line">    _widget = new GestureDetector(</span><br><span class="line">      key: key,</span><br><span class="line">      child: _widget,</span><br><span class="line">      onTap: onTap ?? _onTapFunc,</span><br><span class="line">      onDoubleTap: onDoubleTap ?? _onDoubleTapFunc,</span><br><span class="line">      onLongPress: onLongPress ?? _onLongPressFunc,</span><br><span class="line">    );</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///添加点击事件</span><br><span class="line">  WidgetDecoration onTap(Function func, &#123;Key key&#125;) &#123;</span><br><span class="line">    _onTapFunc = func;</span><br><span class="line">    _widget = new GestureDetector(</span><br><span class="line">      key: key,</span><br><span class="line">      child: _widget,</span><br><span class="line">      onTap: _onTapFunc,</span><br><span class="line">      onDoubleTap: _onDoubleTapFunc,</span><br><span class="line">      onLongPress: _onLongPressFunc,</span><br><span class="line">    );</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///双击</span><br><span class="line">  WidgetDecoration onDoubleTap(Function func, &#123;Key key&#125;) &#123;</span><br><span class="line">    _onDoubleTapFunc = func;</span><br><span class="line">    _widget = new GestureDetector(</span><br><span class="line">      key: key,</span><br><span class="line">      child: _widget,</span><br><span class="line">      onTap: _onTapFunc,</span><br><span class="line">      onDoubleTap: _onDoubleTapFunc,</span><br><span class="line">      onLongPress: _onLongPressFunc,</span><br><span class="line">    );</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ///长按</span><br><span class="line">  WidgetDecoration onLongPress(Function func, &#123;Key key&#125;) &#123;</span><br><span class="line">    _onLongPressFunc = func;</span><br><span class="line">    _widget = new GestureDetector(</span><br><span class="line">      key: key,</span><br><span class="line">      child: _widget,</span><br><span class="line">      onTap: _onTapFunc,</span><br><span class="line">      onDoubleTap: _onDoubleTapFunc,</span><br><span class="line">      onLongPress: _onLongPressFunc,</span><br><span class="line">    );</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget build() &#123;</span><br><span class="line">    return _widget;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Android相关/webview支持input标签/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Android相关/webview支持input标签/" class="post-title-link" itemprop="url">webview支持input标签</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android相关/" itemprop="url" rel="index"><span itemprop="name">Android相关</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####webview input说明<br>安卓webview禁用input，网上查看各种方案，都存在弊端。<br>经过实践，完整可用调研了支持拍照和图片选择上传。</p>
<p><a href="https://www.jianshu.com/p/19084bbc0747" target="_blank" rel="noopener">1、webview支持input标签</a><br><a href="https://www.jianshu.com/p/40670b459e56" target="_blank" rel="noopener">2、安卓拍照支持适配7.0 takePhoto</a></p>
<p>####1、webview 初始化和销毁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">//webview初始化</span><br><span class="line">@SuppressLint(&quot;SetJavaScriptEnabled&quot;)</span><br><span class="line">public static void initX5Web(WebView x5Webview) &#123;</span><br><span class="line">    Context context = x5Webview.getContext();</span><br><span class="line">    WebSettings webSetting = x5Webview.getSettings();</span><br><span class="line">    webSetting.setJavaScriptEnabled( true );</span><br><span class="line">    webSetting.setAllowFileAccess( true );</span><br><span class="line">    webSetting.setLayoutAlgorithm( WebSettings.LayoutAlgorithm.NARROW_COLUMNS );</span><br><span class="line">    webSetting.setSupportZoom( false );</span><br><span class="line">    webSetting.setBuiltInZoomControls( false );</span><br><span class="line">    webSetting.setDisplayZoomControls(false);   //不显示webview缩放按钮</span><br><span class="line">    webSetting.setUseWideViewPort( true );</span><br><span class="line">    //多窗口问题</span><br><span class="line">    webSetting.setSupportMultipleWindows( false );</span><br><span class="line">    webSetting.setJavaScriptCanOpenWindowsAutomatically( true );</span><br><span class="line"></span><br><span class="line">    //h5数据存储</span><br><span class="line">    webSetting.setAppCacheEnabled( true );</span><br><span class="line">    webSetting.setDomStorageEnabled( true );</span><br><span class="line">    webSetting.setDatabaseEnabled(true);</span><br><span class="line">    webSetting.setAppCachePath(context.getDir(&quot;appcache&quot;, 0).getPath());</span><br><span class="line"></span><br><span class="line">    webSetting.setGeolocationEnabled( true );</span><br><span class="line">    webSetting.setAppCacheMaxSize( Long.MAX_VALUE );</span><br><span class="line">    webSetting.setDatabasePath(context.getDir(&quot;databases&quot;, 0).getPath());</span><br><span class="line">    webSetting.setGeolocationDatabasePath(context.getDir(&quot;geolocation&quot;, 0).getPath());</span><br><span class="line">    webSetting.setPluginState( WebSettings.PluginState.ON_DEMAND );</span><br><span class="line">    webSetting.setRenderPriority( WebSettings.RenderPriority.HIGH );</span><br><span class="line">    webSetting.setCacheMode( WebSettings.LOAD_NO_CACHE );</span><br><span class="line">    //sonic</span><br><span class="line">    x5Webview.removeJavascriptInterface(&quot;searchBoxJavaBridge_&quot;);</span><br><span class="line">    webSetting.setAllowContentAccess(true);</span><br><span class="line">    webSetting.setSavePassword(false);</span><br><span class="line">    webSetting.setSaveFormData(false);</span><br><span class="line">    webSetting.setLoadWithOverviewMode(true);</span><br><span class="line">    webSetting.setDefaultTextEncodingName(&quot;utf-8&quot;);</span><br><span class="line">    webSetting.setLoadsImagesAutomatically(true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//webview销毁方法</span><br><span class="line">public static void onDestroy(WebView mWebView)&#123;</span><br><span class="line">    if (mWebView != null) &#123;</span><br><span class="line">        mWebView.clearHistory();</span><br><span class="line">        ((ViewGroup) mWebView.getParent()).removeView(mWebView);</span><br><span class="line">        mWebView.loadUrl(&quot;about:blank&quot;);</span><br><span class="line">        mWebView.stopLoading();</span><br><span class="line">        mWebView.setWebChromeClient(null);</span><br><span class="line">        mWebView.setWebViewClient(null);</span><br><span class="line">        mWebView.loadDataWithBaseURL(null, &quot;&quot;, &quot;text/html&quot;, &quot;utf-8&quot;, null);</span><br><span class="line">        mWebView.clearHistory();</span><br><span class="line">        mWebView.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####2、webchrome特别支持</p>
<ul>
<li><p>1、 initWebChrome</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">    //webview input 特别支持帮助类</span><br><span class="line">    private WebViewUploadFileHelper helper = new WebViewUploadFileHelper(this);</span><br><span class="line"></span><br><span class="line">    private void initWebChrome() &#123;</span><br><span class="line">        webview.setWebChromeClient( new InputFileWebChromeClient() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public class InputFileWebChromeClient extends WebChromeClient &#123;</span><br><span class="line">    //设置 进度条</span><br><span class="line">    @Override</span><br><span class="line">    public void onProgressChanged(WebView view, int newProgress) &#123;</span><br><span class="line">        super.onProgressChanged( view, newProgress );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // For Android &lt; 3.0</span><br><span class="line">    public void openFileChooser(ValueCallback&lt;Uri&gt; uploadMsg) &#123;</span><br><span class="line">        helper.setUploadMessage( uploadMsg );</span><br><span class="line">        permission( () -&gt; &#123;</span><br><span class="line">            helper.openImageActivity();</span><br><span class="line">        &#125; );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // For Android 3.0+</span><br><span class="line">    public void openFileChooser(ValueCallback&lt;Uri&gt; uploadMsg, String acceptType) &#123;</span><br><span class="line">        helper.setUploadMessage( uploadMsg );</span><br><span class="line">        permission( () -&gt; &#123;</span><br><span class="line">            helper.openImageActivity( acceptType );</span><br><span class="line">        &#125; );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // For Android  &gt; 4.1.1</span><br><span class="line">    public void openFileChooser(ValueCallback&lt;Uri&gt; uploadMsg, String acceptType, String capture) &#123;</span><br><span class="line">        helper.setUploadMessage( uploadMsg );</span><br><span class="line">        permission( () -&gt; &#123;</span><br><span class="line">            helper.openImageActivity( acceptType, capture );</span><br><span class="line">        &#125; );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // For Android  &gt;= 5.0</span><br><span class="line">    public boolean onShowFileChooser(com.tencent.smtt.sdk.WebView webView,</span><br><span class="line">                                     ValueCallback&lt;Uri[]&gt; filePathCallback,</span><br><span class="line">                                     WebChromeClient.FileChooserParams fileChooserParams) &#123;</span><br><span class="line">        helper.setUploadMessageAboveL( filePathCallback );</span><br><span class="line">        permission( () -&gt; &#123;</span><br><span class="line">            helper.openImageActivity( fileChooserParams.getAcceptTypes(), fileChooserParams.isCaptureEnabled() );</span><br><span class="line">        &#125; );</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //==多窗口的问题</span><br><span class="line">    @Override</span><br><span class="line">    public boolean onCreateWindow(WebView view, boolean isDialog,</span><br><span class="line">                                  boolean isUserGesture, Message resultMsg) &#123;</span><br><span class="line">        WebView.WebViewTransport transport = (WebView.WebViewTransport) resultMsg.obj;</span><br><span class="line">        transport.setWebView( view );</span><br><span class="line">        resultMsg.sendToTarget();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">* 2 、回调</span><br></pre></td></tr></table></figure>
<p>  @Override<br>  protected void onActivityResult(int requestCode, int resultCode, Intent data) {</p>
<pre><code>//回调支持
 super.onActivityResult(requestCode, resultCode, data);
 helper.onActivityResult(requestCode, resultCode, data);
</code></pre><p>  }</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 3 、权限</span><br></pre></td></tr></table></figure>
<p>  @SuppressLint(“CheckResult”)<br>  public void permission(CallBack callBack){</p>
<pre><code>// 权限支持
 RxPermissions rxPermissions = new RxPermissions( this );
 rxPermissions.request(Manifest.permission.CAMERA, Manifest.permission.WRITE_EXTERNAL_STORAGE, Manifest.permission.READ_EXTERNAL_STORAGE)
         .subscribe(grant -&gt; {
             if (grant) {
                 //全部通过
                 try {
                     if (callBack!=null){
                         callBack.onSucess();
                     }
                 } catch (Throwable throwable) {
                     throwable.printStackTrace();
                 }
             } else {
                     ToastUtils.show(&quot;请同意权限&quot;);
             }
         });
</code></pre><p>  }</p>
<p>  public interface CallBack{</p>
<pre><code>void onSucess();
</code></pre><p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 3、WebViewUploadFileHelper 帮助类</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将input相关方法封装在一个帮助类中，便于多处复用</span><br><span class="line">```java</span><br><span class="line"></span><br><span class="line">public class WebViewUploadFileHelper &#123;</span><br><span class="line"></span><br><span class="line">    private ValueCallback&lt;Uri&gt; uploadMessage;</span><br><span class="line">    private ValueCallback&lt;Uri[]&gt; uploadMessageAboveL;</span><br><span class="line">    private final static int FILE_CHOOSER_RESULT_CODE = 10011;//文件选择</span><br><span class="line">    private Uri imageUri;</span><br><span class="line">    private Activity activity;</span><br><span class="line"></span><br><span class="line">    private WebViewUploadFileHelper() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WebViewUploadFileHelper(Activity activity) &#123;</span><br><span class="line">        this.activity = activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUploadMessage(ValueCallback&lt;Uri&gt; uploadMessage) &#123;</span><br><span class="line">        this.uploadMessage = uploadMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUploadMessageAboveL(ValueCallback&lt;Uri[]&gt; uploadMessageAboveL) &#123;</span><br><span class="line">        this.uploadMessageAboveL = uploadMessageAboveL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onActivityResult(int requestCode, int resultCode, Intent data) &#123;</span><br><span class="line">        if (requestCode != FILE_CHOOSER_RESULT_CODE) return;</span><br><span class="line"></span><br><span class="line">        // 经过上边(1)、(2)两个赋值操作，此处即可根据其值是否为空来决定采用哪种处理方法</span><br><span class="line">        if (uploadMessage != null) &#123;</span><br><span class="line">            chooseBelow( resultCode, data );</span><br><span class="line">        &#125; else if (uploadMessageAboveL != null) &#123;</span><br><span class="line">            chooseAbove( resultCode, data );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void openImageActivity() &#123;</span><br><span class="line">        chooseImage( &quot;image/*&quot; );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void openImageActivity(String acceptType) &#123;</span><br><span class="line">        chooseImage( acceptType );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void openImageActivity(String acceptType, String capture) &#123;</span><br><span class="line">        if (StringUtils.equals( capture, &quot;camera&quot; )) &#123;</span><br><span class="line">            takePhoto();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            chooseImage( acceptType );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void openImageActivity(String[] acceptType, boolean isCaptureEnabled) &#123;</span><br><span class="line">        if (isCaptureEnabled) &#123;</span><br><span class="line">            takePhoto();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            chooseImage( acceptType );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void chooseBelow(int resultCode, Intent data) &#123;</span><br><span class="line"></span><br><span class="line">        if (RESULT_OK == resultCode) &#123;</span><br><span class="line">            updatePhotos();</span><br><span class="line"></span><br><span class="line">            if (data != null) &#123;</span><br><span class="line">                // 这里是针对文件路径处理</span><br><span class="line">                Uri uri = data.getData();</span><br><span class="line">                if (uri != null) &#123;</span><br><span class="line">                    uploadMessage.onReceiveValue( uri );</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    uploadMessage.onReceiveValue( null );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 以指定图像存储路径的方式调起相机，成功后返回data为空</span><br><span class="line">                uploadMessage.onReceiveValue( imageUri );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uploadMessage.onReceiveValue( null );</span><br><span class="line">        &#125;</span><br><span class="line">        uploadMessage = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void chooseAbove(int resultCode, Intent data) &#123;</span><br><span class="line">        if (RESULT_OK == resultCode) &#123;</span><br><span class="line">            updatePhotos();</span><br><span class="line"></span><br><span class="line">            if (data != null) &#123;</span><br><span class="line">                // 这里是针对从文件中选图片的处理</span><br><span class="line">                Uri[] results;</span><br><span class="line">                Uri uriData = data.getData();</span><br><span class="line">                if (uriData != null) &#123;</span><br><span class="line">                    results = new Uri[]&#123;uriData&#125;;</span><br><span class="line">                    uploadMessageAboveL.onReceiveValue( results );</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    uploadMessageAboveL.onReceiveValue( null );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                uploadMessageAboveL.onReceiveValue( new Uri[]&#123;imageUri&#125; );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uploadMessageAboveL.onReceiveValue( null );</span><br><span class="line">        &#125;</span><br><span class="line">        uploadMessageAboveL = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void updatePhotos() &#123;</span><br><span class="line">        // 该广播即使多发（即选取照片成功时也发送）也没有关系，只是唤醒系统刷新媒体文件</span><br><span class="line">        Intent intent = new Intent( Intent.ACTION_MEDIA_SCANNER_SCAN_FILE );</span><br><span class="line">        intent.setData( imageUri );</span><br><span class="line">        activity.sendBroadcast( intent );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //调用相机</span><br><span class="line">    private void takePhoto() &#123;</span><br><span class="line">        String fileName = &quot;IMG_&quot; + DateFormat.format( &quot;yyyyMMdd_hhmmss&quot;, Calendar.getInstance( Locale.CHINA ) ) + &quot;.jpg&quot;;</span><br><span class="line">        // 步骤一：创建存储照片的文件</span><br><span class="line">        String imagePath = activity.getFilesDir() + File.separator + &quot;images&quot; + File.separator + fileName;</span><br><span class="line">        File file = new File( imagePath );</span><br><span class="line">        //创建文件夹</span><br><span class="line">        if (!file.getParentFile().exists())</span><br><span class="line">            file.getParentFile().mkdirs();</span><br><span class="line"></span><br><span class="line">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">            //步骤二：Android 7.0及以上获取文件 Uri</span><br><span class="line">            imageUri = FileProvider.getUriForFile( activity, activity.getPackageName() + &quot;.fileprovider&quot;, file );</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //步骤三：获取文件Uri</span><br><span class="line">            imageUri = Uri.fromFile( file );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Intent intent = new Intent();</span><br><span class="line">        intent.addFlags( Intent.FLAG_GRANT_READ_URI_PERMISSION );</span><br><span class="line">        intent.setAction( MediaStore.ACTION_IMAGE_CAPTURE );//设置Action为拍照</span><br><span class="line">        intent.putExtra( MediaStore.EXTRA_OUTPUT, imageUri );//将拍取的照片保存到指定URI</span><br><span class="line">        activity.startActivityForResult( intent, FILE_CHOOSER_RESULT_CODE );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //图片选择器</span><br><span class="line">    private void chooseImage(String[] acceptType) &#123;</span><br><span class="line">        Intent i = new Intent( Intent.ACTION_GET_CONTENT );</span><br><span class="line">        i.addCategory( Intent.CATEGORY_OPENABLE );</span><br><span class="line">        i.setType( &quot;*/*&quot; );</span><br><span class="line">        i.putExtra( Intent.EXTRA_MIME_TYPES, acceptType );</span><br><span class="line">        activity.startActivityForResult( i, FILE_CHOOSER_RESULT_CODE );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //图片选择器</span><br><span class="line">    private void chooseImage(String acceptType) &#123;</span><br><span class="line">        Intent i = new Intent( Intent.ACTION_GET_CONTENT );</span><br><span class="line">        i.addCategory( Intent.CATEGORY_OPENABLE );</span><br><span class="line">        if (TextUtils.isEmpty( acceptType )) &#123;</span><br><span class="line">            i.setType( &quot;*/*&quot; );</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            i.setType( acceptType );</span><br><span class="line">        &#125;</span><br><span class="line">        activity.startActivityForResult( Intent.createChooser( i, &quot;Image Chooser&quot; ), FILE_CHOOSER_RESULT_CODE );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Android相关/kotlin惯用语法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Android相关/kotlin惯用语法/" class="post-title-link" itemprop="url">kotlin惯用语法</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android相关/" itemprop="url" rel="index"><span itemprop="name">Android相关</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####kotlin模拟运行器<br><a href="https://try.kotlinlang.org/" target="_blank" rel="noopener">https://try.kotlinlang.org/</a></p>
<p>####惯用语法</p>
<ul>
<li>函数定义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//有返回值</span><br><span class="line">fun sum(a: Int, b: Int): Int &#123;</span><br><span class="line">    return a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//无返回值</span><br><span class="line">fun printSum(a: Int, b: Int) &#123;</span><br><span class="line">println(&quot;sum of $a and $b is $&#123;a + b&#125;&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//只读</span><br><span class="line">val a: Int = 1</span><br><span class="line"></span><br><span class="line">//变量</span><br><span class="line">var x = 5</span><br></pre></td></tr></table></figure>
<ul>
<li>字符串模板 $</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var a = 1 </span><br><span class="line">val s1 = &quot;a is $a&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>条件表达式统一写法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (a &gt; b) &#123;</span><br><span class="line">        return a</span><br><span class="line">&#125; else &#123;</span><br><span class="line">        return b </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>空值校验 null</li>
</ul>
<p>当某个变量的值可以为 null 的时候，必须在声明处的类型后添加 ? 来标识该引用可为空<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val str: String ?= null</span><br></pre></td></tr></table></figure></p>
<ul>
<li>数据类型检测</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fun getStringLength(obj: Any): Int?&#123;</span><br><span class="line">    if(obj is String)&#123;</span><br><span class="line">        return obj.length</span><br><span class="line">    &#125;</span><br><span class="line">    return null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用for循环</li>
</ul>
<p>1、类似java增强for循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//推荐这种写法</span><br><span class="line">val items = listOf(&quot;apple&quot;, &quot;banana&quot;, &quot;kiwifruit&quot;) </span><br><span class="line">for (item in items) &#123;</span><br><span class="line">    println(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val items = listOf(&quot;apple&quot;, &quot;banana&quot;, &quot;kiwifruit&quot;) </span><br><span class="line">for (index in items.indices) </span><br><span class="line">&#123;</span><br><span class="line">    println(&quot;item at $index is $&#123;items[index]&#125;&quot;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for (i in array.indices) &#123;</span><br><span class="line">    println(array[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for ((index, value) in array.withIndex()) &#123; </span><br><span class="line">    println(&quot;the element at $index is $value&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>while循环方法<br>优点：对index进行精确控制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val items = listOf(&quot;apple&quot;, &quot;banana&quot;, &quot;kiwifruit&quot;) </span><br><span class="line">var index = 0</span><br><span class="line">while (index &lt; items.size) &#123;</span><br><span class="line">    println(&quot;item at $index is $&#123;items[index]&#125;&quot;)</span><br><span class="line">    index++ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>区间方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//升序</span><br><span class="line">val n = 11</span><br><span class="line">for (x in 1..n step 2) </span><br><span class="line">&#123; </span><br><span class="line">    print(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//降序</span><br><span class="line">for (x in 9 downTo 0 step 3) </span><br><span class="line">&#123;</span><br><span class="line">    print(x) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>区间检测</li>
</ul>
<p>1、是否在某范围内<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val x = 10</span><br><span class="line">val y = 9</span><br><span class="line">if (x in 1..y+1) &#123;</span><br><span class="line">    println(&quot;fits in range&quot;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>when 表达式 (取代switch)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">when (x) &#123;</span><br><span class="line">    1 -&gt; print(&quot;x == 1&quot;) </span><br><span class="line">    2 -&gt; print(&quot;x == 2&quot;) </span><br><span class="line">    else -&gt; &#123; // default</span><br><span class="line">        print(&quot;x is neither 1 nor 2&quot;) </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>集合遍历</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//推荐用法</span><br><span class="line">for (item in items) &#123;</span><br><span class="line">    println(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//推荐用法</span><br><span class="line">for ((key, value) in map) &#123;</span><br><span class="line">    println(&quot;$key -&gt; $value&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或 判断集合是否包含<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">when &#123;</span><br><span class="line">    &quot;orange&quot; in items -&gt; println(&quot;juicy&quot;)</span><br><span class="line">    &quot;apple&quot; in items -&gt; println(&quot;apple is fine too&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或 使用 lambda 表达式来过滤(filter)与映射(map)集合:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val fruits = listOf(&quot;banana&quot;, &quot;avocado&quot;, &quot;apple&quot;, &quot;kiwifruit&quot;)</span><br><span class="line"></span><br><span class="line">fruits</span><br><span class="line">    .filter&#123; it.startsWith(&quot;a&quot;) &#125;</span><br><span class="line">    .sortedBy &#123; it &#125;</span><br><span class="line">    .map &#123; it.toUpperCase() &#125;</span><br><span class="line">    .forEach &#123; println(it) &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建对象 不需要“new”关键字</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val rectangle = Rectangle(5.0, 2.0)</span><br></pre></td></tr></table></figure>
<p>####习惯用法</p>
<ul>
<li>创建实体类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//推荐实体类要有默认参数</span><br><span class="line">data class Customer(val name: String = &quot;&quot;, var email: String = &quot;&quot;)</span><br><span class="line"></span><br><span class="line">var customer: Customer = Customer(&quot;chentong&quot;,&quot;7045xxx&quot;)</span><br><span class="line">println(customer.toString())</span><br><span class="line"></span><br><span class="line">var customer01: Customer = Customer(name=&quot;kk&quot;)</span><br><span class="line">customer01.email = &quot;1986xxx&quot;    println(customer01.toString())</span><br><span class="line"></span><br><span class="line">//强烈推荐这种写法 语义清晰</span><br><span class="line">var customer02: Customer = Customer(name=&quot;tong&quot;,email=&quot;890xxx&quot;)</span><br><span class="line">println(customer02.toString())</span><br><span class="line"></span><br><span class="line">var customer03: Customer = Customer(&quot;03&quot;)</span><br><span class="line">customer03.email = &quot;1986xxx&quot;</span><br><span class="line">println(customer03.toString())</span><br><span class="line"></span><br><span class="line">var customer04: Customer = Customer()</span><br><span class="line">println(customer04.toString())</span><br></pre></td></tr></table></figure>
<p>1）自带getter、setter、toString、hashcode方法<br>2）val(只读) 没有setter方法<br>3）如果生成的类需要含有一个无参的构造函数，则所有的属性必须指定默认值</p>
<ul>
<li>函数默认参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun foo(a: Int = 0, b: String = &quot;&quot;) &#123; ...... &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤 list(filter 内是判断条件)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val listdata = listOf(1, 2, 3, -1)</span><br><span class="line">println(listdata.toString())</span><br><span class="line">    </span><br><span class="line">var newdata = listdata.filter&#123; it &gt; 0 &#125; </span><br><span class="line">println(newdata.toString())</span><br></pre></td></tr></table></figure>
<ul>
<li>map创建</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//打印map</span><br><span class="line">fun printMap(map: Map&lt;String,Any?&gt;)&#123;</span><br><span class="line">    for ((key, value) in map) &#123;</span><br><span class="line">        println(&quot;$key -&gt; $value&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//强烈推荐第一种写法 语义清晰</span><br><span class="line">var map = HashMap&lt;String,Any?&gt;()</span><br><span class="line">map.put(&quot;chen&quot;,&quot;tong&quot;)</span><br><span class="line">map.put(&quot;yang&quot;,&quot;yue&quot;)</span><br><span class="line">printMap(map)</span><br><span class="line"></span><br><span class="line">var map01 = mutableMapOf&lt;String, Any?&gt;()</span><br><span class="line">map01[&quot;chen01&quot;] = &quot;tong&quot;</span><br><span class="line">map01[&quot;yang01&quot;] = &quot;yue&quot;</span><br><span class="line">printMap(map01)</span><br><span class="line"></span><br><span class="line">var map02: HashMap&lt;String,String&gt; = HashMap()</span><br><span class="line">map02.put(&quot;chen02&quot;,&quot;tong&quot;)</span><br><span class="line">map02.put(&quot;yang02&quot;,&quot;yue&quot;)</span><br><span class="line">printMap(map02)</span><br><span class="line"></span><br><span class="line">var chen03 = &quot;tong&quot;</span><br><span class="line">var yang03 =&quot;yue&quot;</span><br><span class="line">var yuan03 = &quot;dong&quot;</span><br><span class="line">//左key,右value    </span><br><span class="line">var map03 = mutableMapOf(&quot;chen03&quot; to chen03, &quot;yang03&quot; to yang03,&quot;yuan03&quot; to yuan03)</span><br><span class="line">printMap(map03)</span><br><span class="line"></span><br><span class="line">val map04: MutableMap&lt;String, Any?&gt; = mutableMapOf()</span><br><span class="line">map04.put(&quot;chen04&quot;,&quot;tong&quot;)</span><br><span class="line">map04.put(&quot;yang04&quot;,&quot;yue&quot;)</span><br><span class="line">map04[&quot;yuan04&quot;] = &quot;dong&quot;</span><br><span class="line">printMap(map04)</span><br></pre></td></tr></table></figure>
<p><strong>强烈推荐第一种写法</strong><br>原因：<br>1、简单少，语法清晰，<br>2、与java写法一致，上手成本低，易于理解<br>3、分辨map是到底哪种实现方式很重要</p>
<ul>
<li>list创建</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//list打印</span><br><span class="line">fun printList(list: List&lt;Any?&gt;)&#123;</span><br><span class="line">    for (item in list) &#123;</span><br><span class="line">        println(&quot;$item&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    println(&quot;===end===&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val lists = listOf(&quot;lists&quot;, &quot;123&quot;, &quot;456&quot;) </span><br><span class="line">//没有add方法</span><br><span class="line">printList(lists)</span><br><span class="line"></span><br><span class="line">//强烈推荐这种写法</span><br><span class="line">var lists01 = ArrayList&lt;String&gt;()</span><br><span class="line">lists01.add(&quot;lists01&quot;)</span><br><span class="line">lists01.add(&quot;banana&quot;)    </span><br><span class="line">printList(lists01)</span><br><span class="line"></span><br><span class="line">val lists02: MutableList&lt;String&gt; = mutableListOf(&quot;lists02&quot;,&quot;02121&quot;)</span><br><span class="line">lists02.add(&quot;testadd&quot;)</span><br><span class="line">printList(lists02)</span><br><span class="line"></span><br><span class="line">//推荐这种写法</span><br><span class="line">var lists03: MutableList&lt;String&gt; = mutableListOf()</span><br><span class="line">lists03.add(&quot;lists03&quot;)</span><br><span class="line">lists03.add(&quot;676767&quot;)</span><br><span class="line">printList(lists03)</span><br></pre></td></tr></table></figure>
<p><strong>推荐第2、4种写法，清晰，简洁</strong></p>
<ul>
<li>只读list map</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val list = listOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br><span class="line"></span><br><span class="line">val map = mapOf(&quot;a&quot; to 1, &quot;b&quot; to 2, &quot;c&quot; to 3)</span><br></pre></td></tr></table></figure>
<ul>
<li>访问map</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var map = HashMap&lt;String,String&gt;()</span><br><span class="line">map.put(&quot;chen&quot;,&quot;tong&quot;)</span><br><span class="line">map[&quot;zhang&quot;] = &quot;san&quot;     </span><br><span class="line"></span><br><span class="line">println(map.get(&quot;zhang&quot;))    </span><br><span class="line">println(map.get(&quot;chen&quot;))</span><br><span class="line"></span><br><span class="line">println(map[&quot;zhang&quot;]) </span><br><span class="line">println(map[&quot;chen&quot;])</span><br></pre></td></tr></table></figure>
<p>快速访问推荐下面👇<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(map[&quot;key&quot;]) </span><br><span class="line">map[&quot;key&quot;] = value</span><br></pre></td></tr></table></figure></p>
<ul>
<li>延迟属性</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val p: String by lazy &#123; </span><br><span class="line">// 计算该字符串</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建单例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">object Resource &#123;</span><br><span class="line">    val name = &quot;Name&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#####安全判断</p>
<ul>
<li>if not null缩写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val lists = listOf(&quot;123&quot;)</span><br><span class="line">println(lists?.size)</span><br></pre></td></tr></table></figure>
<ul>
<li>if not null{} else{} 缩写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val lists = listOf(&quot;123&quot;)</span><br><span class="line">println(lists?.size ?: &quot;empty&quot;)</span><br><span class="line">println(&quot;内容&quot; ?: &quot;empty&quot;)</span><br><span class="line">println(null ?: &quot;empty&quot;)</span><br></pre></td></tr></table></figure>
<ul>
<li>if not null </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val lists = listOf(&quot;123&quot;)</span><br><span class="line">lists?.let &#123;</span><br><span class="line">	// 代码会执行到此处, 假如data不为null</span><br><span class="line">    println(lists.size)</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">* 返回 when 表达式</span><br></pre></td></tr></table></figure>
<p>fun transform(color: String): Int {<br>    return when (color) {<br>        “Red” -&gt; 0<br>        “Green” -&gt; 1<br>        “Blue” -&gt; 2<br>        else -&gt; throw IllegalArgumentException(“Invalid color param value”)<br>    }<br>}</p>
<p>println(transform(“Red”))</p>
<p>println(transform(“1”))<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 单表达式用法</span><br></pre></td></tr></table></figure></p>
<p>fun theAnswer() = 42<br>//等于<br>fun theAnswer(): Int {<br>    return 42<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 一个对象调用多种方法</span><br></pre></td></tr></table></figure></p>
<p>class Turtle {<br>    fun penDown(){<br>        println(“penDown()”)<br>    }</p>
<pre><code>fun penUp(){
    println(&quot;penUp()&quot;)
}

fun turn(degrees: Double){
    println(&quot;turn($degrees)&quot; )
}

fun forward(pixels: Double){
    println(&quot;forward($pixels)&quot;)
}
</code></pre><p>}</p>
<p>val myTurtle = Turtle()<br>with(myTurtle) { // 画一个 100 像素的正方形<br>    penDown()<br>    for(i in 1..4)<br>    {<br>        forward(100.0)<br>        turn(90.0)<br>    }<br>    penUp()<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*  **优先使用try 、if 与 when表达形式**</span><br></pre></td></tr></table></figure></p>
<p>return if (x) foo() else bar()</p>
<p>return when(x) {<br>    0 -&gt; “zero”<br>    else -&gt; “nonzero”<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下面代码不建议使用</span><br></pre></td></tr></table></figure></p>
<p>if (x)<br>    return foo()<br>else<br>    return bar()</p>
<p>when(x) {<br>    0 -&gt; return “zero”<br>    else -&gt; return “nonzero”<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if 适用两个条件 when 适用多个条件</span><br><span class="line"></span><br><span class="line">####基础知识</span><br><span class="line">数字面值中间加下划线，易于读</span><br><span class="line">val oneMillion = 1_000_000</span><br><span class="line"></span><br><span class="line">kotlin 不使用位运算</span><br><span class="line"></span><br><span class="line">数组Array</span><br><span class="line"></span><br><span class="line">* if 表达式 会返回值，或代码块中值</span><br></pre></td></tr></table></figure></p>
<p>// 传统用法<br>var max = a<br>if (a &lt; b) max = b</p>
<p>// 作为表达式<br>val max = if (a &gt; b) a else b<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*for循环 补充</span><br></pre></td></tr></table></figure></p>
<p>for (i in array.indices) {<br>    println(array[i])<br>}</p>
<p>for ((index, value) in array.withIndex()) {<br>    println(“the element at $index is $value”)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">* 标签 @ 即跳转地址 不建议采用</span><br><span class="line">合理使用 return 、break、continue取代</span><br></pre></td></tr></table></figure></p>
<p>fun foo() {<br>    listOf(1, 2, 3, 4, 5).forEach lit@{<br>        if (it == 3) return@lit // 局部返回到该 lambda 表达式的调用者，即 forEach 循环<br>        print(it)<br>    }<br>    print(“ done with explicit label”)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">####类与对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* 类的写法</span><br></pre></td></tr></table></figure></p>
<p>class  Person{<br>    var name: String = “chentong” </p>
<pre><code>//主构造函数    
constructor()
//主构造函数 初始化代码

init{
    name = name + &quot; from Init&quot;
}

constructor(name: String){
    this.name = name+&quot; from name&quot;
}

constructor(name: String, from: String){
    this.name = name + &quot; from &quot; + from
}
</code></pre><p>}  </p>
<p>var person = Person()<br>println(person.name)</p>
<p>var person01 = Person(“yan”)<br>println(person01.name)</p>
<p>var person02 = Person(“kun”,” China “)<br>println(person02.name)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 类继承</span><br></pre></td></tr></table></figure></p>
<p>open class Base(p: Int)<br>class Derived(p: Int) : Base(p)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 方法覆盖</span><br></pre></td></tr></table></figure></p>
<p>open class Base {<br>    open fun v() { … }<br>    fun nv() { … }<br>}<br>class Derived() : Base() {<br>    override fun v() { … }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 属性覆盖</span><br></pre></td></tr></table></figure></p>
<p>open class Foo {<br>open val x: Int get() { …… }<br>}<br>class Bar1 : Foo() {<br>    override val x: Int = ……<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">子类不覆盖基类open成员</span><br><span class="line"></span><br><span class="line">#####抽象类</span><br></pre></td></tr></table></figure></p>
<p>open class Base {<br>    open fun f() {}<br>}<br>abstract class Derived : Base() { override abstract fun f()<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#####接口</span><br><span class="line"></span><br><span class="line">**接口不建议写方法体，也不建议写属性字段**</span><br><span class="line">**原则就是清晰，易懂无歧义**</span><br></pre></td></tr></table></figure></p>
<p>interface MyInterface {<br>    fun bar()<br>    fun foo() {// 可选的方法体}<br>}</p>
<p>class Child : MyInterface {<br>    override fun bar() {// 方法体 }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#####可见性修饰</span><br><span class="line">private :文件内可见</span><br><span class="line">protected :只在本类与子类可见，外界引用不可见</span><br><span class="line">internal:能⻅到类声明的本模块内的任何客戶端都可⻅其 internal 成员（相同模块）</span><br><span class="line">public ：默认是public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#####扩展</span><br></pre></td></tr></table></figure></p>
<p>class C {<br>    fun foo(){println(“member”) }<br>}</p>
<p>fun C.foo(i: Int) {println(“extension”)}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">####泛型</span><br></pre></td></tr></table></figure>
<p> class Box<t>(t: T) {<br>     var value = t<br>}</t></p>
<p>val box = Box<int>()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">形变</span><br><span class="line">in/out</span><br><span class="line">解决通配符问题</span><br><span class="line"></span><br><span class="line">类型擦除</span><br><span class="line"></span><br><span class="line">延时属性lazy 线程安全的</span><br></pre></td></tr></table></figure></int></p>
<p>val lazyValue: String by lazy {<br>    println(“computed!”) “Hello”<br>}</p>
<p>fun main(args: Array<string>) {<br>    println(lazyValue)<br>    println(lazyValue)<br>}<br><code>`</code></string></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/Caliburn随笔/语录笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/Caliburn随笔/语录笔记/" class="post-title-link" itemprop="url">语录笔记</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Caliburn随笔/" itemprop="url" rel="index"><span itemprop="name">Caliburn随笔</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####1、1994年</p>
<p>######赴美考察记<br>教育救国。我公司聚集优秀人才、提高 人才浓度的政策是正确的。尽管它暂时增加了生产成本<br>美国人十分执著的钻研与 认真精神，看到如绅士风度一般的有条不紊、井井有条的管理。各类文件十分清晰、准确，并有良好的覆盖，是一项成功的系统工程。</p>
<p>整个考察期间，我们深感，美国人踏踏实实、十分专一的认真精神，精益求精的 工作作风，毫无保守的学术风气，是值得我们学习的。</p>
<p>美国人没有像中国人那么多远大的理想，也没有胸怀祖国、放眼世界的空洞抱 负，也不像我们那样充满幻想。这个民族踏踏实实、不屈不挠的奋斗精神是值 得我们学习的。</p>
<p>再穷不能穷教育</p>
<p>越繁荣越发展科技，越发展科技越重视教育，越重视教育越人才辈出，越人才 辈出经济越繁荣，走入了一个良性的循环圈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们路过费城，看了一个年收人约 4 万美元的中国留学生(已工作) 家庭。冬天 冻得十分冷，他们舍不得开暖气。小太太对我讲:这样一年才能节约 100 美元。</span><br><span class="line">而且国内亲戚一开口就要他们寄 1 万美金。他们国也不敢回。吃的、用的都十 分简单。</span><br><span class="line"></span><br><span class="line">中国人是省吃俭用，留给后代，美国人狂花乱花，广交朋友。中国人永远陷在中 国人的圈子里，永远跳不进钱窝，在富裕的美国，仍然贫穷。美国人朋友越交</span><br><span class="line">越多，机会越来越好，钱也越挣越多。人生的成功，8 0% 在机会。</span><br></pre></td></tr></table></figure>
<p><code>人生的成功，8 0% 在机会</code></p>
<p>美国已开始将工业最核心的部分保留在 本土生产，其余大量转移到世界各国的分公司生产，以降低成本，增强竞争力。这一点到硅谷以后，感觉更加强烈</p>
<p>中国人不出去看一看，闭门造车，不仅不可能赶上别人，而且可 能从时代的列车上摔下来。我们已处在入关的微妙时期，应保持良好的市场与 技术信息。公司将会一批一批地安排同志们出去看一看。</p>
<p>我们 不拼命发展技术、最终会丢失全部市场</p>
<p>值得庆幸的一点是我们的员工个人素质都不比美国公司差。因此赶上美国，十 分重要的一条就是改善管理</p>
<p>美国人民绝大多数是勤劳的，好学的。我们应该学习他们的不屈不挠、一丝不 苟的奋斗精神。<br>从来就没有什么神仙、皇帝，我们中华民族唯有踏踏实实、面对自己的弱点，才 有可能振兴。世世代代繁荣梦的破灭，使我们更深地感觉到了技术上向美国学习， 管理上向日本学习的深刻含意。</p>
<p>######团结奋斗 再创华为佳绩<br><code>这次从国外回来，我有一个很深的感觉，觉得国外的中青年人有一个很伟大之处， 就是他们没有什么空洞的理想，脚踏实地做好每项不起眼的工作。搞焊接的，对 每一焊点质量充分保证，能钻研进去，在这方面成为专家，也有价值上的承认， 照样拿高工资。他们是为生活好而奋斗，多挣钱买房、买车、旅游。干什么爱什 么。而我们的青年人，干干就想着提升，就想脱离自己的岗位，一辈子熟练程度 都不够。</code></p>
<p><code>我们中有些人可悲的就是理想太多，总想轰轰烈烈干大事。到了办事处看不起维 修工作，就急着要做市场，要当副主任、主任，结果什么也没干好，理想也没实 现。制造部的人也不甘落后，争着上市场，我与他们谈话，要脚踏实地做好本职 工作，到市场部淘汰很快，也许一、二个月就退下来，再回到制造部，还不如当 初留在制造部做好适于你发展的工作。</code><br>马克思在 100 多年前就告诉我们一条真理，我们要深刻地去理解它。“从来就没 有什么救世主，也没有神仙皇帝，中国要富强，必须靠自己。”我们从事的事业，<br>是为了祖国的利益、人民的利益、民族的利益。相信我们的事业一定会胜利，一 定能胜利。</p>
<h6 id="从二则空难事故看员工培训的重要性"><a href="#从二则空难事故看员工培训的重要性" class="headerlink" title="从二则空难事故看员工培训的重要性"></a>从二则空难事故看员工培训的重要性</h6><p>从难从严，从实际出发，各级组织，加强员工培训</p>
<h4 id="1995年"><a href="#1995年" class="headerlink" title="1995年"></a>1995年</h4><h6 id="坚定不移地坚持发展的方向"><a href="#坚定不移地坚持发展的方向" class="headerlink" title="坚定不移地坚持发展的方向"></a>坚定不移地坚持发展的方向</h6><p>树立榜样<br>1、新老干部要团结。一方面要看到，长江后浪推前流，新人永远比老人行，后人总要超过前人<br>2、要搞好团结，首先团结本小组、本部门的人<br>3、一定要尊重上级，因为，以后你可能也会走上领导岗位，也需要你的下级尊 重你。<br>4、我们要团结所有人，要团结一切可以团结的人，包括曾反对过你，而且反错 了的人。大家本是同根生，都是背井离乡人，应以博大的胸怀处理周边关系。<br>5、过渡时期的兼职，要尽快减少。培养新人，逐步接过火把，使组织建设得更 充实。<br>6、公司全体高中级干部要坚决反腐败、反贪污、反盗窃、反假公济私、反一切 违法行为。</p>
<p>重新规范组织与规划工作流程<br>1、“变法”一定要保证科学性，要保持<br>不断的协调，要先“立”后“破”，这样才能避免旧的已经废除，新的还未产生，制 度上的真空地带引起的混乱。<br>2、要吸取现代科学精髓，但也要重视老方法。公司在组织变革上，要采取“补台” 而非拆台的政策，赞成改良，不希望“天翻地覆”的改革。<br>三、坚定不移地坚持发展的方向<br>1、由于我们在通信领域，已有良好的市场、开发资源，所以在近期，我们在产 品范围上坚持通信多元化产品。<br>2、我们要继续坚持“压强原则”，即集中力量，在一个点、一个面上有重大突破， 这样，逐步改善公司的总体条件。<br>3、公司遇到了千载难逢的历史时机，要抓住机会，加速发展。<br>四、要建立实事求是，严格认真、广泛吸纳的工作作风<br>五、灵活机动的战略战术<br>1、公司在各系统增加层次，是为了加快决策速度<br>2、多层组织建设，能充分发掘 基层的创造性<br>3、公司各系统都把培训放在很重要的位置</p>
<h6 id="任正非谈秘书如何服务"><a href="#任正非谈秘书如何服务" class="headerlink" title="任正非谈秘书如何服务"></a>任正非谈秘书如何服务</h6><p>1、主动地服务<br><code>2、善解人意</code><br>善解人意，通俗地说，就是人家想做啥，你就把这个事情准备好;或者是人家说了这句话，你就把它整理成一个有条理的东西</p>
<p>当然，要做到善解人意，你必须拓宽你的知识面。如果你不精通天文地理，不通 晓古往今来的历史，不了解世界科技发展的现状，你怎么可能善解人意?这是从<br>大的方面讲;从小的方面讲，华为公司有什么重大决策，有什么样的规划、计划…… 公司发了这么多的文件，你是否认真去读过、思考过?</p>
<p>另外，你还要努力寻找彼此间共同的语言，如何才能与经理产生共同的语言，你 琢磨过了吗?</p>
<p>这些都是你达到善解人意的前提条件。否则，你就不能善解人意。既然不能善解 人意，则要你这个秘书又有何用呢?你一定要理解你的领导要做什么?与周边的 关系需要你的领导来解决什么?你的领导应该向周围扩散什么?公司的这个运 行火车里头有什么在运行?你只有把握住了这个脉搏，才可能成为一个好秘书</p>
<p>我记得张燕燕做秘书的时候，石油部的领导对她有过很好的评价。他对我说:“你 的这个秘书，特别能善解人意。你想做什么事，她在电话里就帮你处理了，但是 你并没有交待她做什么事。”</p>
<p>第三，秘书要善于归纳。<br>我觉得秘书的差距有时是很大的，其差距就在归纳上。</p>
<p>以前我讲完话以后，我的秘书很快就能归纳成一篇文章。其实，文章里有些话我 并不就是这么说的，而且在说话过程中，废话一定也不少，这是口语嘛!所以， 这就要求秘书善于归纳总结给我看。如果我觉得需要改动的很少，那我就认为这 个秘书的水平高，她能够理解、善解人意、善于归纳。</p>
<p>第四，公司要重视文档建设。</p>
<h6 id="目前我们的形势和任务"><a href="#目前我们的形势和任务" class="headerlink" title="目前我们的形势和任务"></a>目前我们的形势和任务</h6><p>从科技兴国做起，没有下一个十年的卧薪尝胆，不从基 础做起，从根本抓起，美梦还是美梦。科技兴国，是我们下世纪的曙光。<br>以市场换技术不可行<br>没有独立的民族工业，就没有民族的独立。</p>
<p>市场换技术不可行</p>
<p>只有自己才能救 自己。从来就没有什么救世主，也不靠神仙皇帝，中国要发展，必须要靠自强</p>
<p>中国人终于认识到，外国人到中国是赚钱来的，他们不肯把底交给中国人，中国 人得到的只是感染，促使了观念的转化。他们转让技术的手段，都是希望过几年 您还要再引进，然后，引进、引进、再引进，最终不能自立。以市场换技术，市 场丢光了，哪一样技术真正掌握了?从痛苦中认识到，没有自己的科技支撑体系， 工业独立是一句空话。没有独立的民族工业，就没有民族的独立。</p>
<p>压强原则，集中一切可以集中的力量，突破一点，局 部领先，使华为渡过起步的艰难</p>
<p>全身发抖，全世界 没有我们这么搞科研的，同时采用这么多新技术，没有样机借鉴，一步到位地从 头设计，幸亏我们成功了，失败了后果真不堪设想。<br>历史上只有敢想才能敢干，只有敢于革命才能善于革命</p>
<p>体系作战</p>
<p>####1996年<br>我们要做一个目光远大的人，但得从小事做起。那种不愿做小事，不愿深入实际 去积累经验，不愿走与基层员工相结合的道路的人，只能是一位高高在上的官员</p>
<p>一般人只注意身体上的艰苦奋斗，却不注重思想上的艰苦奋斗。科学家、企业家、 善于经营的个体户、养猪能手，他们都是思想上的艰苦奋斗。为了比别人做得更 好一点，为了得到一个科学上的突破、为了一个点的市场占有率、为了比别人价 格低些、为了养更多更好的猪，他们在精神上承受了难以想象的压力、殚精竭虑， 他们有的人比较富裕，但并不意味他们不艰苦奋斗，比起身体上的艰苦奋斗，思 想上的艰苦奋斗更不被人理解，然而也有更大的价值。评价一个人的工作应考虑 这种区别。</p>
<p>思想上勤奋，善于思考，才更有价值</p>
<p>我们要向市场、开发、创造性工作倾斜</p>
<p>人才的不断筛选</p>
<p>胜则举杯相庆 败则拼死相救</p>
<p>######我们向美国人民学习什么<br>一、前赴后继的创新精神与浪起云涌的创新机制</p>
<p>科教兴国是中国走向富强的必然之路</p>
<p>二、优良的企业管理</p>
<p>管理模型</p>
<p>1、保持技术领先;<br>2、以客户的价值观为导向，按对象 组建营销部门。针对不同行业提供全套解决方案;<br>3、强化服务、追求客户满意 度;<br>4、集中精力在网络类电子商务产品上发挥 IBM 的规模优势。</p>
<p>规模是优势， 规模优势的基础是管理</p>
<p>企 业缩小规模就会失去竞争力，扩大规模，不能有效管理，又面临死亡，管理是 内部因素，是可以努力的。规模小，面对的都是外部因素，是客观规律，是难 以以人的意志为转移的，它必然抗不住风暴。因此，我们只有加强管理与服务， 在这条不归路上，才有生存的基础。这就是华为要走规模化、搞活内部动力机 制、加强管理与服务的战略出发点。</p>
<p>三、机会是企业扩张的动力<br>IBM 明确技术领先战略，贝尔实验室更是如此。所有美国高科技公司的宗旨无 不如此，没有一个公司提出跟在别人后面，模仿的战略是不会长久的。</p>
<p>在科学的入口处，真正是地狱的入口处，进去了的人才真正体会得到。 基础研究的痛苦是成功了没人理解，甚至被曲解、被误解。象饿死的梵高一样，死后画 卖到几千万美元一幅。当我看到贝尔实验室的科学家的实验室密如蛛网，混乱不 堪，不由得对这些勇士，肃然起敬。华为不知是否会产生这样的勇士。<br>寻找机会，抓住机会，是后进者的名言。创造机会，引导消费，是先驱者的座右铭</p>
<p>不带有陈见去认识竞争对手，认真向他们学习好的东西，才有希望追赶上他们。</p>
<p>艰苦奋斗</p>
<p>创新一定要在理解基础上去创新，而不是在没有完全充分理解以后就表明一些东西，你那是在出风头，而我想那出风头的人就把他请出我们这个小组 去，这是第一点。</p>
<p>力出一孔，要集中优势资源投入在主航道上，敢于去争取更大 的机会与差距</p>
<p>三个人拿四个人的钱，干五 个人的活，就是我们未来的期望。这样改变以后，华为将一枝独秀。</p>
<p>要敢于超越美国公司，最多就是输<br>一、片联是公司的重要组织，要尽快行动起来，担负起历史的重任，推动<br>干部循环流动。</p>
<p>二、考察干部，要从大节上选拔有奋斗精神的的干部，看干部的长远性， 不要抓住缺点不放;同时干部要约束自己，严格控制自己的欲望。</p>
<p>选拔人才注重人的大节，就是要敢于奋斗、不怕吃苦，不要小富则安。公司有 些人目光短浅，好不容易赚两个钱后就要移民加拿大，他没有志向，为什么要选 他做干部?叫苦连天的干部也不要，美国情报委员会文件一出，少数人叫苦连天， 说他的项目受影响，这么快影响了?怎么可能?这种贪生怕死、没用的胆小鬼， 为什么要用他?</p>
<p>一方面，组织要看到干部的长远性，不要总抓住缺点， 要给予改正的机会。另一方面，干部要严格控制自己的欲望，要看长远利益， 不要看蝇头小利</p>
<p>三、行政改革，先建设后改变，要重视行政服务管理人员的选拔，均衡发展。</p>
<p>####2018 年</p>
<p>######坚持多路径、多梯次、多场景化的研发路线，攻上“上甘岭”，实现 5G 战略领先</p>
<p>领先和领导是不同的。领导的含义是要建立规则，建立共同胜 利的标准。领先，就是在技术、商业模式、质量及服务成本、财经等方面一系列 领先。如果我们的产品做得好，就能服务世界上绝大多数运营商，这样就能掌握<br>主动权。所以在 5G 的问题上，我们就是要下定决心做到战略领先。</p>
<p>一、先从 5G SA 组网做起，要做到网络架构极简、交易架构极简、网络极安全、隐私保护极可靠、能耗极低，全面实现领先。</p>
<p>5G SA 通过站点极简、运维极 简、交易极简等，把复杂留给自己，简单留给客户，这是非常正确的</p>
<p>二、对未来的研究，我们要多路径、多梯次、多场景，构筑我们胜利的基础。</p>
<p>三、5G 的市场选择要有集中度，5G 的战略预备队要一体化打通，“四组一队”攻 上“上甘岭”</p>
<p>我再次强调，我们 5G 就是争夺“上甘岭”，就是世界高地。5G 这一战关系着公司的生死存亡，所以我们一定要在这场“战争”中不惜代价赢得胜利。攻上“上甘岭”， 全要靠你们。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/java高并发编程/java线程深入讲解及线程池实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/java高并发编程/java线程深入讲解及线程池实现/" class="post-title-link" itemprop="url">java线程深入讲解及线程池实现</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java高并发编程/" itemprop="url" rel="index"><span itemprop="name">java高并发编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####1、基础概念</p>
<p>线程：程序执行流最小单元。<br>线程拥有各自计数器，堆栈，局部变量的属性，并且能够访问共享内存变量</p>
<p>注意：线程可以访问共享内存变量，高并发是指多线程对共享资源的原子操作。</p>
<p>线程优先级：1-10级，默认是5，高优先级分配时间片数量多于低优先级<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.setPriority(5);</span><br></pre></td></tr></table></figure></p>
<p>注意：优先级不能作为程序正确性依赖，因操作系统差异</p>
<p>精灵进程：后台调度及支持性工作的进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.setDaemon(true);</span><br></pre></td></tr></table></figure>
<p>####2、线程状态</p>
<p>java线程状态6种：</p>
<table>
<thead>
<tr>
<th>线程状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>初始状态(NEW)</td>
<td>新创建了一个线程对象，但还没有调用start()方法</td>
</tr>
<tr>
<td>运行状态(RUNNABLE)</td>
<td>Java线程中将就绪（ready）和运行中（running）两种状态笼统的成为“运行”。</td>
</tr>
<tr>
<td>阻塞状态(BLOCKED)</td>
<td>表示线程阻塞于锁</td>
</tr>
<tr>
<td>等待状态(WAITING)</td>
<td>进入该状态的线程需要等待</td>
</tr>
<tr>
<td>超时等待状态(TIME_WAITING)</td>
<td>该状态不同于WAITING，它可以在指定的时间内自行返回</td>
</tr>
<tr>
<td>终止状态(TERMINATED)</td>
<td>表示该线程已经执行完毕</td>
</tr>
</tbody>
</table>
<p><img src="https://upload-images.jianshu.io/upload_images/5526061-9852cf763271acad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="线程状态图"></p>
<p>####3、线程函数<br>| 函数名 | 作用 |<br>| — | — |<br>| sleep | 休眠，对象锁不会释放，不可以被interrupt（）中断 |<br>| join | 等待目标程序完成后再继续执行 |<br>| yield | 线程礼让，运行状态转为就绪状态，让出执行权 |<br>| interrupt | 中断线程 |<br>| IsInterrupted | 判断线程是否被中断 |</p>
<p>#####1）关键点：</p>
<ol>
<li><p>join与yield区别<br>join 线程之间顺序执行<br>yield 让出当前线程执行权</p>
</li>
<li><p>启动线程之前，最好构建名字，便于定位</p>
</li>
<li><p>中断理解：线程中断的标识位，由其他线程通知该线程，若当前线程sleep,则无法中断</p>
</li>
<li><p>过期方法suspend、resume、stop不用。原因：陷入暂停、停止，线程不会释放占有资源，引发不确定性</p>
</li>
<li><p>安全终止线程：<br> 1）interrupt中断<br> 2）用boolean变量控制</p>
<p> 实战示例</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//实现demo</span><br><span class="line">private class WorkRunner implements Runnable&#123;</span><br><span class="line">    private volatile boolean switchFlag = true; // boolean变量线程安全且插入屏障</span><br><span class="line">    </span><br><span class="line">    public void run()&#123;</span><br><span class="line">        //两重判断，一个boolean，一个支持中断状态</span><br><span class="line">        while(switchFlag &amp;&amp; !Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">            doSomething()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void cancel()&#123;</span><br><span class="line">        switchFlag = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//调用者</span><br><span class="line">main()&#123;</span><br><span class="line">    Thread thread = new Thread(new WorkRunner(), &quot;work&quot;);</span><br><span class="line">    thread.start()</span><br><span class="line">    //两种中断方法</span><br><span class="line">    thread.interrupt();</span><br><span class="line">    thread.cancel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>####对象锁</p>
<table>
<thead>
<tr>
<th>函数名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>wait</td>
<td>当前线程调用对象的wait()方法，当前线程释放对象锁，进入等待队列。</td>
</tr>
<tr>
<td>wait(long timeout)</td>
<td>超时等待返回，单位毫秒</td>
</tr>
<tr>
<td>wait(long,int)</td>
<td>单位纳秒</td>
</tr>
<tr>
<td>notify</td>
<td>通知一个在对象上等待的线程，使其wait返回</td>
</tr>
<tr>
<td>notifyAll</td>
<td>通知所有等待线程在该对象的线程</td>
</tr>
</tbody>
</table>
<p><strong>wait，notify等方法必须放在synchroized代码块中</strong></p>
<p>####经典范例</p>
<p>#####等待-通知（生产消费者）</p>
<ol>
<li><p>消费者<br> 1）获取对象的锁<br> 2）条件不满足等待（wait），被通知后仍要检查条件<br> 3）条件满足执行</p>
</li>
<li><p>生产者<br>1）获得对象的锁<br>2）改变条件<br>3）通知所有等待对象上的线程</p>
</li>
</ol>
<p>伪代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">synchrionized(对象)&#123;</span><br><span class="line">    while(条件不满足)&#123;</span><br><span class="line">        对象.wait();</span><br><span class="line">    &#125;</span><br><span class="line">    处理逻辑</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">synchionized(对象)&#123;</span><br><span class="line">    改变条件</span><br><span class="line">    对象.notifyAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>#####实战编程</p>
<p>1、消费者 须增加超时设计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public synchrionized void fetch()&#123;</span><br><span class="line">    long future =   System.currentTimeMills()+mills;</span><br><span class="line">    long remaining = mills;</span><br><span class="line">    while( 条件 &amp;&amp; remaining &gt; 0)&#123;</span><br><span class="line">        对象.wait(remaining);</span><br><span class="line">        remaining = future - System.currentTimeMills();</span><br><span class="line">    &#125;</span><br><span class="line">    处理逻辑</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优点：避免方法执行时间过长，不会永久阻塞调用者</p>
<p>2、阻塞队列BlockQueue<br>阻塞队列用来给生产者与消费者解耦</p>
<p>3、线程池<br>本质一个线程安全工作队列连接工作者线程和客户端线程 </p>
<p>实现线程池的三步<br>1、实现线程安全的阻塞队列 (生产者-消费者范例)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public interface BlockQueue&lt;E&gt;&#123;</span><br><span class="line">    void add(E e); //添加元素</span><br><span class="line">    E take();      //取走元素</span><br><span class="line">    E take(int timeout);</span><br><span class="line">    int size(); //队列size</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ArrayBlockQueue&lt;E&gt; implement BlockQueue&lt;E&gt;&#123;</span><br><span class="line">    </span><br><span class="line">    private List&lt;E&gt; blockList = new ArrayList();</span><br><span class="line">    private Object lock = new Object();</span><br><span class="line">    private volaitle int size = 0;</span><br><span class="line">    </span><br><span class="line">    //生产者</span><br><span class="line">    public void add(E e)&#123;</span><br><span class="line">        synchionized(lock)&#123;</span><br><span class="line">            blockList.add(e);</span><br><span class="line">            lock.notifyAll();   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //消费者</span><br><span class="line">    public E take(int timeout)&#123;</span><br><span class="line">    </span><br><span class="line">        synchionized(lock)&#123;</span><br><span class="line">            if(timeout &lt;= 0)&#123;</span><br><span class="line">                while(blockList.isEmpty())&#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                long future = System.currentTimeMills()+timeout;</span><br><span class="line">                long remaining = timeout;</span><br><span class="line">                while(blockList.isEmpty() &amp;&amp; remain &gt; 0)&#123;</span><br><span class="line">                    lock.wait(remaining);            </span><br><span class="line">                    remaining = future - System.currentTimeMills();</span><br><span class="line">                &#125;                </span><br><span class="line">            &#125;</span><br><span class="line">        return blockList.get(0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //消费者</span><br><span class="line">    public E take()&#123;</span><br><span class="line">        return take(0);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //获得当前队列大小</span><br><span class="line">    public int size()&#123;</span><br><span class="line">        synchionized(lock)&#123;</span><br><span class="line">            size = blockList.size();  </span><br><span class="line">        &#125;</span><br><span class="line">        return size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2、编写执行者可安全终止的Worker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public Worker&lt;Job extend Runnable&gt; implement Runnable&#123;</span><br><span class="line">    private volatile boolean switchFlag = true;</span><br><span class="line">    private BlockQueue&lt;Job&gt; blockQueue;</span><br><span class="line">    </span><br><span class="line">    public Worker(BlockQueue queue)&#123;</span><br><span class="line">        blockQueue = queue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void run()&#123;</span><br><span class="line">        while(switchFlag &amp;&amp; !Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">            Job job = blockQueue.take();</span><br><span class="line">            job.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public shutdown()&#123;</span><br><span class="line">        switchFlag = false;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、线程池框架</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">线程池接口规范</span><br><span class="line">public interface ThreadPool&lt;Job extends Runnable&gt;&#123;</span><br><span class="line">    //执行工作</span><br><span class="line">    void execute(Job job);</span><br><span class="line">    //关闭线程池</span><br><span class="line">    void shutdown();</span><br><span class="line">    //增加线程</span><br><span class="line">    void addWorker(int num);</span><br><span class="line">    //减少线程</span><br><span class="line">    void removeWork(int num);</span><br><span class="line">    //当前任务job数</span><br><span class="line">    int getJobSize();</span><br><span class="line">    //当前线程数</span><br><span class="line">    int getThreadCount();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public SimpleThreadPool&lt;Job extends Runnable&gt; implement ThreadPool&lt;Job&gt;&#123;</span><br><span class="line"></span><br><span class="line">//任务阻塞队列</span><br><span class="line">private BlockQueue&lt;Job&gt; blockQueue = new ArrayBlockQueue()&lt;Job&gt;;</span><br><span class="line"></span><br><span class="line">//线程队列</span><br><span class="line">private List&lt;Worker&gt; workerList = Collections.sysnchronizedList(new ArrayList&lt;Worker&gt;);</span><br><span class="line"></span><br><span class="line">//最大线程数</span><br><span class="line">private static final int MAX_WORK_NUM = 10;</span><br><span class="line"></span><br><span class="line">//默认线程数</span><br><span class="line">private static final int DEFAULT_WORK_NUM = 3;</span><br><span class="line"></span><br><span class="line">public SimpleThreadPool()&#123;</span><br><span class="line">    addWorker(DEFAULT_WORK_NUM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//执行任务</span><br><span class="line">public void execute(Job job)&#123;</span><br><span class="line">    blockQueue.add(job);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//关闭线程池</span><br><span class="line">public void synchrionized shutdown()&#123;</span><br><span class="line">    for(Worker worker : workerList)&#123;</span><br><span class="line">        worker.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//增加线程任务</span><br><span class="line">public synchrionized void addWorker(int num)&#123;</span><br><span class="line">   //当前线程数</span><br><span class="line">   int threadNum = workerList.size();</span><br><span class="line">      //限制创建线程数不能超过最大限度</span><br><span class="line">      if(threadNum + num &gt; MAX_WORK_NUM)&#123;</span><br><span class="line">       num = MAX_WORK_NUM - threadNum ;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   for(int i = 0; i &lt; num ; i++)&#123;</span><br><span class="line">        creatOneWorker();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public synchrionized void removeWorker(int num)&#123;</span><br><span class="line">    //当前线程数</span><br><span class="line">   int threadNum = workerList.size();</span><br><span class="line">   //最大删除数是当前线程数</span><br><span class="line">   if(num &gt; threadNum)&#123;</span><br><span class="line">        num = threadNum;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    //移除工作线程</span><br><span class="line">    for(int i = 0; i &lt; num ;i++)&#123;</span><br><span class="line">        Worker worker = workerList.get(i);</span><br><span class="line">        worker.shutdown();</span><br><span class="line">        workerList.remove(worker);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//当前线程数</span><br><span class="line">public synchrionized int getThreadCount()&#123;</span><br><span class="line">    return workerList.size();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//获得当前任务数</span><br><span class="line">public int getJobSize()&#123;</span><br><span class="line">    return blockQueue.size();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//创建一个线程</span><br><span class="line">private void creatOneWorker()&#123;</span><br><span class="line">     //创建工作者</span><br><span class="line">    Worker worker = new Worker(blockQueue);</span><br><span class="line">    workerList.add(worker);</span><br><span class="line">    Thread thread = new Thread(worker);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/kotlin/kotlin经典用法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/kotlin/kotlin经典用法/" class="post-title-link" itemprop="url">kotlin经典用法</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:49" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/kotlin/" itemprop="url" rel="index"><span itemprop="name">kotlin</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>####kotlin模拟运行器<br><a href="https://try.kotlinlang.org/" target="_blank" rel="noopener">https://try.kotlinlang.org/</a></p>
<p>####惯用语法</p>
<ul>
<li>函数定义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//有返回值</span><br><span class="line">fun sum(a: Int, b: Int): Int &#123;</span><br><span class="line">    return a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//无返回值</span><br><span class="line">fun printSum(a: Int, b: Int) &#123;</span><br><span class="line">println(&quot;sum of $a and $b is $&#123;a + b&#125;&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//只读</span><br><span class="line">val a: Int = 1</span><br><span class="line"></span><br><span class="line">//变量</span><br><span class="line">var x = 5</span><br></pre></td></tr></table></figure>
<ul>
<li>字符串模板 $</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var a = 1 </span><br><span class="line">val s1 = &quot;a is $a&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>条件表达式统一写法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (a &gt; b) &#123;</span><br><span class="line">        return a</span><br><span class="line">&#125; else &#123;</span><br><span class="line">        return b </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>空值校验 null</li>
</ul>
<p>当某个变量的值可以为 null 的时候，必须在声明处的类型后添加 ? 来标识该引用可为空<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val str: String ?= null</span><br></pre></td></tr></table></figure></p>
<ul>
<li>数据类型检测</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fun getStringLength(obj: Any): Int?&#123;</span><br><span class="line">    if(obj is String)&#123;</span><br><span class="line">        return obj.length</span><br><span class="line">    &#125;</span><br><span class="line">    return null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用for循环</li>
</ul>
<p>1、类似java增强for循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//推荐这种写法</span><br><span class="line">val items = listOf(&quot;apple&quot;, &quot;banana&quot;, &quot;kiwifruit&quot;) </span><br><span class="line">for (item in items) &#123;</span><br><span class="line">    println(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val items = listOf(&quot;apple&quot;, &quot;banana&quot;, &quot;kiwifruit&quot;) </span><br><span class="line">for (index in items.indices) </span><br><span class="line">&#123;</span><br><span class="line">    println(&quot;item at $index is $&#123;items[index]&#125;&quot;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for (i in array.indices) &#123;</span><br><span class="line">    println(array[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for ((index, value) in array.withIndex()) &#123; </span><br><span class="line">    println(&quot;the element at $index is $value&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>while循环方法<br>优点：对index进行精确控制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val items = listOf(&quot;apple&quot;, &quot;banana&quot;, &quot;kiwifruit&quot;) </span><br><span class="line">var index = 0</span><br><span class="line">while (index &lt; items.size) &#123;</span><br><span class="line">    println(&quot;item at $index is $&#123;items[index]&#125;&quot;)</span><br><span class="line">    index++ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>区间方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//升序</span><br><span class="line">val n = 11</span><br><span class="line">for (x in 1..n step 2) </span><br><span class="line">&#123; </span><br><span class="line">    print(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//降序</span><br><span class="line">for (x in 9 downTo 0 step 3) </span><br><span class="line">&#123;</span><br><span class="line">    print(x) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>区间检测</li>
</ul>
<p>1、是否在某范围内<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val x = 10</span><br><span class="line">val y = 9</span><br><span class="line">if (x in 1..y+1) &#123;</span><br><span class="line">    println(&quot;fits in range&quot;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>when 表达式 (取代switch)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">when (x) &#123;</span><br><span class="line">    1 -&gt; print(&quot;x == 1&quot;) </span><br><span class="line">    2 -&gt; print(&quot;x == 2&quot;) </span><br><span class="line">    else -&gt; &#123; // default</span><br><span class="line">        print(&quot;x is neither 1 nor 2&quot;) </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>集合遍历</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//推荐用法</span><br><span class="line">for (item in items) &#123;</span><br><span class="line">    println(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//推荐用法</span><br><span class="line">for ((key, value) in map) &#123;</span><br><span class="line">    println(&quot;$key -&gt; $value&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或 判断集合是否包含<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">when &#123;</span><br><span class="line">    &quot;orange&quot; in items -&gt; println(&quot;juicy&quot;)</span><br><span class="line">    &quot;apple&quot; in items -&gt; println(&quot;apple is fine too&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或 使用 lambda 表达式来过滤(filter)与映射(map)集合:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val fruits = listOf(&quot;banana&quot;, &quot;avocado&quot;, &quot;apple&quot;, &quot;kiwifruit&quot;)</span><br><span class="line"></span><br><span class="line">fruits</span><br><span class="line">    .filter&#123; it.startsWith(&quot;a&quot;) &#125;</span><br><span class="line">    .sortedBy &#123; it &#125;</span><br><span class="line">    .map &#123; it.toUpperCase() &#125;</span><br><span class="line">    .forEach &#123; println(it) &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建对象 不需要“new”关键字</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val rectangle = Rectangle(5.0, 2.0)</span><br></pre></td></tr></table></figure>
<p>####习惯用法</p>
<ul>
<li>创建实体类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//推荐实体类要有默认参数</span><br><span class="line">data class Customer(val name: String = &quot;&quot;, var email: String = &quot;&quot;)</span><br><span class="line"></span><br><span class="line">var customer: Customer = Customer(&quot;chentong&quot;,&quot;7045xxx&quot;)</span><br><span class="line">println(customer.toString())</span><br><span class="line"></span><br><span class="line">var customer01: Customer = Customer(name=&quot;kk&quot;)</span><br><span class="line">customer01.email = &quot;1986xxx&quot;    println(customer01.toString())</span><br><span class="line"></span><br><span class="line">//强烈推荐这种写法 语义清晰</span><br><span class="line">var customer02: Customer = Customer(name=&quot;tong&quot;,email=&quot;890xxx&quot;)</span><br><span class="line">println(customer02.toString())</span><br><span class="line"></span><br><span class="line">var customer03: Customer = Customer(&quot;03&quot;)</span><br><span class="line">customer03.email = &quot;1986xxx&quot;</span><br><span class="line">println(customer03.toString())</span><br><span class="line"></span><br><span class="line">var customer04: Customer = Customer()</span><br><span class="line">println(customer04.toString())</span><br></pre></td></tr></table></figure>
<p>1）自带getter、setter、toString、hashcode方法<br>2）val(只读) 没有setter方法<br>3）如果生成的类需要含有一个无参的构造函数，则所有的属性必须指定默认值</p>
<ul>
<li>函数默认参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun foo(a: Int = 0, b: String = &quot;&quot;) &#123; ...... &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤 list(filter 内是判断条件)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val listdata = listOf(1, 2, 3, -1)</span><br><span class="line">println(listdata.toString())</span><br><span class="line">    </span><br><span class="line">var newdata = listdata.filter&#123; it &gt; 0 &#125; </span><br><span class="line">println(newdata.toString())</span><br></pre></td></tr></table></figure>
<ul>
<li>map创建</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//打印map</span><br><span class="line">fun printMap(map: Map&lt;String,Any?&gt;)&#123;</span><br><span class="line">    for ((key, value) in map) &#123;</span><br><span class="line">        println(&quot;$key -&gt; $value&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//强烈推荐第一种写法 语义清晰</span><br><span class="line">var map = HashMap&lt;String,Any?&gt;()</span><br><span class="line">map.put(&quot;chen&quot;,&quot;tong&quot;)</span><br><span class="line">map.put(&quot;yang&quot;,&quot;yue&quot;)</span><br><span class="line">printMap(map)</span><br><span class="line"></span><br><span class="line">var map01 = mutableMapOf&lt;String, Any?&gt;()</span><br><span class="line">map01[&quot;chen01&quot;] = &quot;tong&quot;</span><br><span class="line">map01[&quot;yang01&quot;] = &quot;yue&quot;</span><br><span class="line">printMap(map01)</span><br><span class="line"></span><br><span class="line">var map02: HashMap&lt;String,String&gt; = HashMap()</span><br><span class="line">map02.put(&quot;chen02&quot;,&quot;tong&quot;)</span><br><span class="line">map02.put(&quot;yang02&quot;,&quot;yue&quot;)</span><br><span class="line">printMap(map02)</span><br><span class="line"></span><br><span class="line">var chen03 = &quot;tong&quot;</span><br><span class="line">var yang03 =&quot;yue&quot;</span><br><span class="line">var yuan03 = &quot;dong&quot;</span><br><span class="line">//左key,右value    </span><br><span class="line">var map03 = mutableMapOf(&quot;chen03&quot; to chen03, &quot;yang03&quot; to yang03,&quot;yuan03&quot; to yuan03)</span><br><span class="line">printMap(map03)</span><br><span class="line"></span><br><span class="line">val map04: MutableMap&lt;String, Any?&gt; = mutableMapOf()</span><br><span class="line">map04.put(&quot;chen04&quot;,&quot;tong&quot;)</span><br><span class="line">map04.put(&quot;yang04&quot;,&quot;yue&quot;)</span><br><span class="line">map04[&quot;yuan04&quot;] = &quot;dong&quot;</span><br><span class="line">printMap(map04)</span><br></pre></td></tr></table></figure>
<p><strong>强烈推荐第一种写法</strong><br>原因：<br>1、简单少，语法清晰，<br>2、与java写法一致，上手成本低，易于理解<br>3、分辨map是到底哪种实现方式很重要</p>
<ul>
<li>list创建</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//list打印</span><br><span class="line">fun printList(list: List&lt;Any?&gt;)&#123;</span><br><span class="line">    for (item in list) &#123;</span><br><span class="line">        println(&quot;$item&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    println(&quot;===end===&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val lists = listOf(&quot;lists&quot;, &quot;123&quot;, &quot;456&quot;) </span><br><span class="line">//没有add方法</span><br><span class="line">printList(lists)</span><br><span class="line"></span><br><span class="line">//强烈推荐这种写法</span><br><span class="line">var lists01 = ArrayList&lt;String&gt;()</span><br><span class="line">lists01.add(&quot;lists01&quot;)</span><br><span class="line">lists01.add(&quot;banana&quot;)    </span><br><span class="line">printList(lists01)</span><br><span class="line"></span><br><span class="line">val lists02: MutableList&lt;String&gt; = mutableListOf(&quot;lists02&quot;,&quot;02121&quot;)</span><br><span class="line">lists02.add(&quot;testadd&quot;)</span><br><span class="line">printList(lists02)</span><br><span class="line"></span><br><span class="line">//推荐这种写法</span><br><span class="line">var lists03: MutableList&lt;String&gt; = mutableListOf()</span><br><span class="line">lists03.add(&quot;lists03&quot;)</span><br><span class="line">lists03.add(&quot;676767&quot;)</span><br><span class="line">printList(lists03)</span><br></pre></td></tr></table></figure>
<p><strong>推荐第2、4种写法，清晰，简洁</strong></p>
<ul>
<li>只读list map</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val list = listOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br><span class="line"></span><br><span class="line">val map = mapOf(&quot;a&quot; to 1, &quot;b&quot; to 2, &quot;c&quot; to 3)</span><br></pre></td></tr></table></figure>
<ul>
<li>访问map</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var map = HashMap&lt;String,String&gt;()</span><br><span class="line">map.put(&quot;chen&quot;,&quot;tong&quot;)</span><br><span class="line">map[&quot;zhang&quot;] = &quot;san&quot;     </span><br><span class="line"></span><br><span class="line">println(map.get(&quot;zhang&quot;))    </span><br><span class="line">println(map.get(&quot;chen&quot;))</span><br><span class="line"></span><br><span class="line">println(map[&quot;zhang&quot;]) </span><br><span class="line">println(map[&quot;chen&quot;])</span><br></pre></td></tr></table></figure>
<p>快速访问推荐下面👇<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(map[&quot;key&quot;]) </span><br><span class="line">map[&quot;key&quot;] = value</span><br></pre></td></tr></table></figure></p>
<ul>
<li>延迟属性</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val p: String by lazy &#123; </span><br><span class="line">// 计算该字符串</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建单例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">object Resource &#123;</span><br><span class="line">    val name = &quot;Name&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#####安全判断</p>
<ul>
<li>if not null缩写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val lists = listOf(&quot;123&quot;)</span><br><span class="line">println(lists?.size)</span><br></pre></td></tr></table></figure>
<ul>
<li>if not null{} else{} 缩写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val lists = listOf(&quot;123&quot;)</span><br><span class="line">println(lists?.size ?: &quot;empty&quot;)</span><br><span class="line">println(&quot;内容&quot; ?: &quot;empty&quot;)</span><br><span class="line">println(null ?: &quot;empty&quot;)</span><br></pre></td></tr></table></figure>
<ul>
<li>if not null </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val lists = listOf(&quot;123&quot;)</span><br><span class="line">lists?.let &#123;</span><br><span class="line">	// 代码会执行到此处, 假如data不为null</span><br><span class="line">    println(lists.size)</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">* 返回 when 表达式</span><br></pre></td></tr></table></figure>
<p>fun transform(color: String): Int {<br>    return when (color) {<br>        “Red” -&gt; 0<br>        “Green” -&gt; 1<br>        “Blue” -&gt; 2<br>        else -&gt; throw IllegalArgumentException(“Invalid color param value”)<br>    }<br>}</p>
<p>println(transform(“Red”))</p>
<p>println(transform(“1”))<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 单表达式用法</span><br></pre></td></tr></table></figure></p>
<p>fun theAnswer() = 42<br>//等于<br>fun theAnswer(): Int {<br>    return 42<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 一个对象调用多种方法</span><br></pre></td></tr></table></figure></p>
<p>class Turtle {<br>    fun penDown(){<br>        println(“penDown()”)<br>    }</p>
<pre><code>fun penUp(){
    println(&quot;penUp()&quot;)
}

fun turn(degrees: Double){
    println(&quot;turn($degrees)&quot; )
}

fun forward(pixels: Double){
    println(&quot;forward($pixels)&quot;)
}
</code></pre><p>}</p>
<p>val myTurtle = Turtle()<br>with(myTurtle) { // 画一个 100 像素的正方形<br>    penDown()<br>    for(i in 1..4)<br>    {<br>        forward(100.0)<br>        turn(90.0)<br>    }<br>    penUp()<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*  **优先使用try 、if 与 when表达形式**</span><br></pre></td></tr></table></figure></p>
<p>return if (x) foo() else bar()</p>
<p>return when(x) {<br>    0 -&gt; “zero”<br>    else -&gt; “nonzero”<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下面代码不建议使用</span><br></pre></td></tr></table></figure></p>
<p>if (x)<br>    return foo()<br>else<br>    return bar()</p>
<p>when(x) {<br>    0 -&gt; return “zero”<br>    else -&gt; return “nonzero”<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if 适用两个条件 when 适用多个条件</span><br><span class="line"></span><br><span class="line">####基础知识</span><br><span class="line">数字面值中间加下划线，易于读</span><br><span class="line">val oneMillion = 1_000_000</span><br><span class="line"></span><br><span class="line">kotlin 不使用位运算</span><br><span class="line"></span><br><span class="line">数组Array</span><br><span class="line"></span><br><span class="line">* if 表达式 会返回值，或代码块中值</span><br></pre></td></tr></table></figure></p>
<p>// 传统用法<br>var max = a<br>if (a &lt; b) max = b</p>
<p>// 作为表达式<br>val max = if (a &gt; b) a else b<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*for循环 补充</span><br></pre></td></tr></table></figure></p>
<p>for (i in array.indices) {<br>    println(array[i])<br>}</p>
<p>for ((index, value) in array.withIndex()) {<br>    println(“the element at $index is $value”)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">* 标签 @ 即跳转地址 不建议采用</span><br><span class="line">合理使用 return 、break、continue取代</span><br></pre></td></tr></table></figure></p>
<p>fun foo() {<br>    listOf(1, 2, 3, 4, 5).forEach lit@{<br>        if (it == 3) return@lit // 局部返回到该 lambda 表达式的调用者，即 forEach 循环<br>        print(it)<br>    }<br>    print(“ done with explicit label”)<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">####类与对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* 类的写法</span><br></pre></td></tr></table></figure></p>
<p>class  Person{<br>    var name: String = “chentong” </p>
<pre><code>//主构造函数    
constructor()
//主构造函数 初始化代码

init{
    name = name + &quot; from Init&quot;
}

constructor(name: String){
    this.name = name+&quot; from name&quot;
}

constructor(name: String, from: String){
    this.name = name + &quot; from &quot; + from
}
</code></pre><p>}  </p>
<p>var person = Person()<br>println(person.name)</p>
<p>var person01 = Person(“yan”)<br>println(person01.name)</p>
<p>var person02 = Person(“kun”,” China “)<br>println(person02.name)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 类继承</span><br></pre></td></tr></table></figure></p>
<p>open class Base(p: Int)<br>class Derived(p: Int) : Base(p)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 方法覆盖</span><br></pre></td></tr></table></figure></p>
<p>open class Base {<br>    open fun v() { … }<br>    fun nv() { … }<br>}<br>class Derived() : Base() {<br>    override fun v() { … }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 属性覆盖</span><br></pre></td></tr></table></figure></p>
<p>open class Foo {<br>open val x: Int get() { …… }<br>}<br>class Bar1 : Foo() {<br>    override val x: Int = ……<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">子类不覆盖基类open成员</span><br><span class="line"></span><br><span class="line">#####抽象类</span><br></pre></td></tr></table></figure></p>
<p>open class Base {<br>    open fun f() {}<br>}<br>abstract class Derived : Base() { override abstract fun f()<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#####接口</span><br><span class="line"></span><br><span class="line">**接口不建议写方法体，也不建议写属性字段**</span><br><span class="line">**原则就是清晰，易懂无歧义**</span><br></pre></td></tr></table></figure></p>
<p>interface MyInterface {<br>    fun bar()<br>    fun foo() {// 可选的方法体}<br>}</p>
<p>class Child : MyInterface {<br>    override fun bar() {// 方法体 }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#####可见性修饰</span><br><span class="line">private :文件内可见</span><br><span class="line">protected :只在本类与子类可见，外界引用不可见</span><br><span class="line">internal:能⻅到类声明的本模块内的任何客戶端都可⻅其 internal 成员（相同模块）</span><br><span class="line">public ：默认是public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#####扩展</span><br></pre></td></tr></table></figure></p>
<p>class C {<br>    fun foo(){println(“member”) }<br>}</p>
<p>fun C.foo(i: Int) {println(“extension”)}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">####泛型</span><br></pre></td></tr></table></figure>
<p> class Box<t>(t: T) {<br>     var value = t<br>}</t></p>
<p>val box = Box<int>()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">形变</span><br><span class="line">in/out</span><br><span class="line">解决通配符问题</span><br><span class="line"></span><br><span class="line">类型擦除</span><br><span class="line"></span><br><span class="line">延时属性lazy 线程安全的</span><br></pre></td></tr></table></figure></int></p>
<p>val lazyValue: String by lazy {<br>    println(“computed!”) “Hello”<br>}</p>
<p>fun main(args: Array<string>) {<br>    println(lazyValue)<br>    println(lazyValue)<br>}<br><code>`</code></string></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/手动编写jvm虚拟机/12、方法调用和返回/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/手动编写jvm虚拟机/12、方法调用和返回/" class="post-title-link" itemprop="url">12、方法调用和返回</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:50" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/手动编写jvm虚拟机/" itemprop="url" rel="index"><span itemprop="name">手动编写jvm虚拟机</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.jianshu.com/p/cb8fe1f365be" target="_blank" rel="noopener">gojvm目录</a><br><a href="https://www.jianshu.com/p/9156bc2bbeba" target="_blank" rel="noopener">1、搭建go环境</a><br><a href="https://www.jianshu.com/p/bea27c053053" target="_blank" rel="noopener">2、cmd命令行参数解析</a><br><a href="https://www.jianshu.com/p/e76c793b5981" target="_blank" rel="noopener">3、搜索class文件</a><br><a href="https://www.jianshu.com/p/aec9576f08f8" target="_blank" rel="noopener">4、添加testOption 便于单元测试</a><br><a href="https://www.jianshu.com/p/97756f2820a8" target="_blank" rel="noopener">5、解析classfile文件</a><br><a href="https://www.jianshu.com/p/682b548e24a3" target="_blank" rel="noopener">6、运行时数据区</a><br><a href="https://www.jianshu.com/p/9775be0d790e" target="_blank" rel="noopener">7、指令集</a><br><a href="https://www.jianshu.com/p/e924ac1da848" target="_blank" rel="noopener">8、解释器</a><br><a href="https://www.jianshu.com/p/072fd852418c" target="_blank" rel="noopener">9、创建Class</a><br><a href="https://www.jianshu.com/p/ba231854662d" target="_blank" rel="noopener">10、类加载器</a><br><a href="https://www.jianshu.com/p/f870bb0959c8" target="_blank" rel="noopener">11、对象实例化new object</a><br><a href="https://www.jianshu.com/p/614cdc94ecd0" target="_blank" rel="noopener">12、方法调用和返回</a><br><a href="https://www.jianshu.com/p/f200ba4aa420" target="_blank" rel="noopener">13 类初始化</a><br><a href="https://www.jianshu.com/p/11ac0e3a92b3" target="_blank" rel="noopener">14、jvm支持数组</a><br><a href="https://www.jianshu.com/p/d27ab1534f52" target="_blank" rel="noopener">15、jvm支持字符串-数组扩展</a><br><a href="https://www.jianshu.com/p/8dd487605bf4" target="_blank" rel="noopener">16、本地方法调用</a><br><a href="https://www.jianshu.com/p/defba0b8941d" target="_blank" rel="noopener">17、ClassLoader原理</a><br><a href="https://www.jianshu.com/p/4b915f356a61" target="_blank" rel="noopener">18、异常处理</a><br><a href="https://www.jianshu.com/p/21a65fbba2e7" target="_blank" rel="noopener">19、 启动jvm</a></p>
<p>####知识扩展<br>静态方法和实例方法</p>
<table>
<thead>
<tr>
<th>静态方法(类方法)</th>
<th>实例方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>通过类调用</td>
<td>通过实例调用</td>
</tr>
<tr>
<td>静态绑定</td>
<td>动态绑定</td>
</tr>
<tr>
<td>编译期确定</td>
<td>运行期确定</td>
</tr>
</tbody>
</table>
<p>invokestatic 静态方法<br>invokespecial 调用无须绑定的实例方法，例如：构造方法，私有方法，super<br>invokeinterface 动态绑定- 调用接口<br>invokevirtual  动态绑定 -其他<br>invokedynamic 动态绑定 扩展</p>
<p>####关键流程</p>
<p>解析符号引用 找方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 从当前类及其父类中查找方法</span><br><span class="line">func lookupMethod(class *Class, name string, descriptor string) *Method &#123;</span><br><span class="line">	method := LookupMethodInClass(class, name, descriptor)</span><br><span class="line">	if method == nil &#123;</span><br><span class="line">		method = lookupMethodInInterfaces(class.interfaces, name, descriptor)</span><br><span class="line">	&#125;</span><br><span class="line">	return method</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####核心方法调用<br>方法调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// invokerFrame - 调用当前的方法的哪一个方法栈帧</span><br><span class="line">// method - 当前方法，即被 invokerFrame 调用的方法</span><br><span class="line">func InvokeMethod(invokerFrame *rtda.Frame, method *heap.Method) &#123;</span><br><span class="line">	// 1.使用同一个线程为当前方法创建栈帧并压入线程栈顶</span><br><span class="line">	thread := invokerFrame.Thread()</span><br><span class="line">	newFrame := thread.NewFrame(method)</span><br><span class="line">	thread.PushFrame(newFrame)</span><br><span class="line"></span><br><span class="line">	// 2. 获取当前方法需要的参数个数，并从调用者 invokerFrame 的操作数栈中弹出制定个数个参数，放到当前方法的栈帧的本地变量中</span><br><span class="line">	argSlotCount := int(method.ArgSlotCount())</span><br><span class="line">	if argSlotCount &gt; 0 &#123;</span><br><span class="line">		for i := argSlotCount - 1; i &gt;= 0; i-- &#123;</span><br><span class="line">			slot := invokerFrame.OperandStack().PopSlot()</span><br><span class="line">			newFrame.LocalVars().SetSlot(uint(i), slot)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//hack</span><br><span class="line">	if method.IsNative() &#123;</span><br><span class="line">		if method.Name() == &quot;registerNatives&quot; &#123;</span><br><span class="line">			thread.PopFrame()</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			panic(fmt.Sprintf(&quot;native method: %v.%v%v</span><br><span class="line">&quot;,</span><br><span class="line">				method.Class().Name(), method.Name(), method.Descriptor()))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 将当前栈帧的返回值（操作数栈顶）移除并推入调用者栈帧的操作数栈顶</span><br><span class="line">// 将当前栈帧从线程中移除</span><br><span class="line">func (self *ARETURN) Execute(frame *rtda.Frame) &#123;</span><br><span class="line">	thread := frame.Thread()</span><br><span class="line">	currentFrame := thread.PopFrame() // 当前方法的栈帧</span><br><span class="line">	invokerFrame := thread.TopFrame() // 调用当前方法的前一个方法的栈帧</span><br><span class="line">	retVal := currentFrame.OperandStack().PopRef()</span><br><span class="line">	invokerFrame.OperandStack().PushRef(retVal)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (self *IRETURN) Execute(frame *rtda.Frame) &#123;</span><br><span class="line">	thread := frame.Thread()</span><br><span class="line">	currentFrame := thread.PopFrame() // 当前方法的栈帧</span><br><span class="line">	invokerFrame := thread.TopFrame() // 调用当前方法的前一个方法的栈帧</span><br><span class="line">	retVal := currentFrame.OperandStack().PopInt()</span><br><span class="line">	invokerFrame.OperandStack().PushInt(retVal)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法调用指令<br>invokestatic 静态方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func (self *INVOKE_STATIC) Execute(frame *rtda.Frame) &#123;</span><br><span class="line">	cp := frame.Method().Class().ConstantPool()</span><br><span class="line">	methodRef := cp.GetConstant(self.Index).(*heap.MethodRef)</span><br><span class="line">	method := methodRef.ResolveMethod() // 根据方法符号引用：方法name、方法描述符descriptor、所包含的类指针 查找方法</span><br><span class="line">	if !method.IsStatic() &#123;</span><br><span class="line">		panic(&quot;java.lang.IncompatibleClassChangeError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	class := methodRef.ResolvedClass()</span><br><span class="line">	if !class.InitStarted() &#123;</span><br><span class="line">		frame.RevertNextPC()</span><br><span class="line">		base.InitClass(frame.Thread(), class)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	base.InvokeMethod(frame, method)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>invokespecial 构造方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func (self *INVOKE_SPECIAL) Execute(frame *rtda.Frame) &#123;</span><br><span class="line">	currentClass := frame.Method().Class()</span><br><span class="line">	cp := currentClass.ConstantPool()</span><br><span class="line">	methodRef := cp.GetConstant(self.Index).(*heap.MethodRef)</span><br><span class="line">	resolvedClass := methodRef.ResolvedClass()</span><br><span class="line">	resolveMethod := methodRef.ResolveMethod()</span><br><span class="line"></span><br><span class="line">        //构造方法</span><br><span class="line">	if resolveMethod.Name() == &quot;&lt;init&gt;&quot; &amp;&amp; resolveMethod.Class() != resolvedClass &#123;</span><br><span class="line">		panic(&quot;java.lang.NoSuchMethodError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if resolveMethod.IsStatic() &#123;</span><br><span class="line">		panic(&quot;java.lang.IncompatibleClassChangeError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">      //todo count -1避免数组越界</span><br><span class="line">	ref := frame.OperandStack().GetRefFromTop(resolveMethod.ArgSlotCount()-1) // 弹出 this 引用</span><br><span class="line">	if ref == nil &#123;</span><br><span class="line">		panic(&quot;java.lang.NullPointerException&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	base.InvokeMethod(frame, resolveMethod)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>invokeinterface<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">func (self *INVOKE_INTERFACE) Execute(frame *rtda.Frame) &#123;</span><br><span class="line">	cp := frame.Method().Class().ConstantPool()</span><br><span class="line">	methodRef := cp.GetConstant(self.index).(*heap.InterfaceMethodRef)</span><br><span class="line">	resolvedMethod := methodRef.ResolvedInterfaceMethod()</span><br><span class="line">	if resolvedMethod.IsStatic() || resolvedMethod.IsPrivate() &#123;</span><br><span class="line">		panic(&quot;java.lang.IncompatibleClassChangeError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ref := frame.OperandStack().GetRefFromTop(resolvedMethod.ArgSlotCount() - 1)</span><br><span class="line">	if ref == nil &#123;</span><br><span class="line">		panic(&quot;java.lang.NullPointerException&quot;) // todo</span><br><span class="line">	&#125;</span><br><span class="line">	if !ref.Class().IsImplements(methodRef.ResolvedClass()) &#123;</span><br><span class="line">		panic(&quot;java.lang.IncompatibleClassChangeError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	methodToBeInvoked := heap.LookupMethodInClass(ref.Class(),</span><br><span class="line">		methodRef.Name(), methodRef.Descriptor())</span><br><span class="line">	if methodToBeInvoked == nil || methodToBeInvoked.IsAbstract() &#123;</span><br><span class="line">		panic(&quot;java.lang.AbstractMethodError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	if !methodToBeInvoked.IsPublic() &#123;</span><br><span class="line">		panic(&quot;java.lang.IllegalAccessError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	base.InvokeMethod(frame, methodToBeInvoked)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####编写解释器interpreter<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Interpret</span><span class="params">(method *heap.Method, logInst <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	thread := rtda.NewTread()        <span class="comment">//创建线程</span></span><br><span class="line">	frame := thread.NewFrame(method) <span class="comment">//创建栈帧</span></span><br><span class="line">	thread.PushFrame(frame)          <span class="comment">//将栈帧push线程stack中</span></span><br><span class="line">	<span class="keyword">defer</span> catchErr(thread)</span><br><span class="line">	loop(thread, logInst)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行指令</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loop</span><span class="params">(thread *rtda.Thread, logInst <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	reader := &amp;base.ByteCodeReader&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">//获取当前栈</span></span><br><span class="line">		frame := thread.CurrentFrame()</span><br><span class="line">		pc := frame.NextPC()</span><br><span class="line">		thread.SetPC(pc)</span><br><span class="line"></span><br><span class="line">		<span class="comment">//decode</span></span><br><span class="line">		reader.Reset(frame.Method().Code(), pc)</span><br><span class="line">		<span class="comment">//读取指令opcode</span></span><br><span class="line">		opcode := reader.ReadUint8()                <span class="comment">// 读取操作码 opCode（指令类型）</span></span><br><span class="line">		inst := instructions.NewInstruction(opcode) <span class="comment">// 根据opCode创建相应的指令</span></span><br><span class="line">		inst.FetchOperands(reader)                  <span class="comment">// 从字节码中读取操作数</span></span><br><span class="line">		frame.SetNextPC(reader.PC())                <span class="comment">// 将当前读取到的字节码的位置设置到 frame 的 nextPc 中，用于执行下一条指令</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> logInst &#123;</span><br><span class="line">			logInstruction(frame, inst)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//执行栈帧</span></span><br><span class="line">		inst.Execute(frame)</span><br><span class="line"></span><br><span class="line">		<span class="comment">//线程中栈帧执行完毕退出</span></span><br><span class="line">		<span class="keyword">if</span> thread.IsStackEmpty() &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####测试demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//函数调用与返回</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokeDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> InvokeDemo().test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InvokeDemo.staticMethod();          <span class="comment">// invokestatic</span></span><br><span class="line">        InvokeDemo demo = <span class="keyword">new</span> InvokeDemo(); <span class="comment">// invokespecial</span></span><br><span class="line">        demo.instanceMethod();              <span class="comment">// invokespecial</span></span><br><span class="line">        <span class="keyword">super</span>.equals(<span class="keyword">null</span>);                 <span class="comment">// invokespecial</span></span><br><span class="line">        <span class="keyword">this</span>.run();                         <span class="comment">// invokevirtual</span></span><br><span class="line">        ((Runnable) demo).run();            <span class="comment">// invokeinterface</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">staticMethod</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">instanceMethod</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>go 测试分支<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//测试函数调用与返回</span><br><span class="line">func parseReturn(cmd *Cmd) &#123;</span><br><span class="line"></span><br><span class="line">	cp := classpath.Parse(cmd.XjreOption, cmd.cpOption)</span><br><span class="line">	//获得classLoader</span><br><span class="line">	classLoader := heap.NewClassLoader(cp, cmd.verboseClassFlag)</span><br><span class="line">	//获得加载类名字</span><br><span class="line">	className := strings.Replace(cmd.class, &quot;.&quot;, &quot;/&quot;, -1)</span><br><span class="line">	mainClass := classLoader.LoadClass(className)</span><br><span class="line">	//获得main方法</span><br><span class="line">	mainMethod := mainClass.GetMainMethod()</span><br><span class="line">	if mainMethod != nil &#123;</span><br><span class="line">		Interpret(mainMethod, cmd.verboseInstFlag)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		fmt.Printf(&quot;Main method not found in class %s</span><br><span class="line">&quot;, cmd.class)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>shell脚本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">测试函数调用返回</span></span><br><span class="line">go run main -verbose:class -verbose:inst  -test "return"  -cp test/lib/example.jar   jvmgo.book.ch07.InvokeDemo</span><br><span class="line">go run main -verbose:class -verbose:inst  -test "return"  -cp test/lib/example.jar   jvmgo.book.ch07.FibonacciTest</span><br></pre></td></tr></table></figure></p>
<h4 id="实战项目地址"><a href="#实战项目地址" class="headerlink" title="实战项目地址"></a>实战项目地址</h4><p><a href="https://github.com/yinlingchaoliu/jvmgo.git" target="_blank" rel="noopener">https://github.com/yinlingchaoliu/jvmgo.git</a></p>
<p>提交代码标记 “return”</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/26/手动编写jvm虚拟机/9、创建Class/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CHEN TONG">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="引领潮流">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/26/手动编写jvm虚拟机/9、创建Class/" class="post-title-link" itemprop="url">9、创建Class</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-26 10:55:48 / Modified: 10:55:51" itemprop="dateCreated datePublished" datetime="2020-05-26T10:55:48+08:00">2020-05-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/手动编写jvm虚拟机/" itemprop="url" rel="index"><span itemprop="name">手动编写jvm虚拟机</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.jianshu.com/p/cb8fe1f365be" target="_blank" rel="noopener">gojvm目录</a><br><a href="https://www.jianshu.com/p/9156bc2bbeba" target="_blank" rel="noopener">1、搭建go环境</a><br><a href="https://www.jianshu.com/p/bea27c053053" target="_blank" rel="noopener">2、cmd命令行参数解析</a><br><a href="https://www.jianshu.com/p/e76c793b5981" target="_blank" rel="noopener">3、搜索class文件</a><br><a href="https://www.jianshu.com/p/aec9576f08f8" target="_blank" rel="noopener">4、添加testOption 便于单元测试</a><br><a href="https://www.jianshu.com/p/97756f2820a8" target="_blank" rel="noopener">5、解析classfile文件</a><br><a href="https://www.jianshu.com/p/682b548e24a3" target="_blank" rel="noopener">6、运行时数据区</a><br><a href="https://www.jianshu.com/p/9775be0d790e" target="_blank" rel="noopener">7、指令集</a><br><a href="https://www.jianshu.com/p/e924ac1da848" target="_blank" rel="noopener">8、解释器</a><br><a href="https://www.jianshu.com/p/072fd852418c" target="_blank" rel="noopener">9、创建Class</a><br><a href="https://www.jianshu.com/p/ba231854662d" target="_blank" rel="noopener">10、类加载器</a><br><a href="https://www.jianshu.com/p/f870bb0959c8" target="_blank" rel="noopener">11、对象实例化new object</a><br><a href="https://www.jianshu.com/p/614cdc94ecd0" target="_blank" rel="noopener">12、方法调用和返回</a><br><a href="https://www.jianshu.com/p/f200ba4aa420" target="_blank" rel="noopener">13 类初始化</a><br><a href="https://www.jianshu.com/p/11ac0e3a92b3" target="_blank" rel="noopener">14、jvm支持数组</a><br><a href="https://www.jianshu.com/p/d27ab1534f52" target="_blank" rel="noopener">15、jvm支持字符串-数组扩展</a><br><a href="https://www.jianshu.com/p/8dd487605bf4" target="_blank" rel="noopener">16、本地方法调用</a><br><a href="https://www.jianshu.com/p/defba0b8941d" target="_blank" rel="noopener">17、ClassLoader原理</a><br><a href="https://www.jianshu.com/p/4b915f356a61" target="_blank" rel="noopener">18、异常处理</a><br><a href="https://www.jianshu.com/p/21a65fbba2e7" target="_blank" rel="noopener">19、 启动jvm</a></p>
<p>####知识扩展<br>方法区存储类信息</p>
<p>创建Class<br>1、存储类信息<br>2、常量池转化为运行时常量池</p>
<p>####1、从classFile读取信息，拷贝到类中</p>
<p>Class<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">type Class struct &#123;</span><br><span class="line">	accessFlags       uint16        // 类访问标志</span><br><span class="line">	name              string        // 类名（全限定）</span><br><span class="line">	superClassName    string        // 父类名（全限定），eg. java/lang/Object</span><br><span class="line">	interfaceNames    []string      // 接口名（全限定）</span><br><span class="line">	constantPool      *ConstantPool // 运行时常量池</span><br><span class="line">	fields            []*Field      // 字段表</span><br><span class="line">	methods           []*Method     // 方法表</span><br><span class="line">	loader            *ClassLoader  // 类加载器</span><br><span class="line">	superClass        *Class        // 父类指针</span><br><span class="line">	interfaces        []*Class      // 实现的接口指针</span><br><span class="line">	instanceSlotCount uint          // 存放实例变量占据的空间大小（包含从父类继承来的实例变量）（其中long和double占两个slot）</span><br><span class="line">	staticSlotCount   uint          // 存放类变量占据的空间大小（只包含当前类的类变量）（其中long和double占两个slot）</span><br><span class="line">	staticVars        Slots         // 存放静态变量</span><br><span class="line">	initStarted       bool</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1、创建class实例总方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func newClass(cf *classfile.ClassFile) *Class &#123;</span><br><span class="line">	class := &amp;Class&#123;&#125;</span><br><span class="line">	class.accessFlags = cf.AccessFlags()</span><br><span class="line">	class.name = cf.ClassName()</span><br><span class="line">	class.superClassName = cf.SuperClassName()</span><br><span class="line">	class.interfaceNames = cf.InterfaceNames()</span><br><span class="line">	class.constantPool = newConstantPool(class, cf.ConstantPool())</span><br><span class="line">	class.fields = newFields(class, cf.Fields())</span><br><span class="line">	class.methods = newMethods(class, cf.Methods())</span><br><span class="line">	return class</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>公共字段信息 (访问标志，访问名字，描述符)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// Field 与 Method 的父类，不是 Class 的父类</span><br><span class="line">type ClassMember struct &#123;</span><br><span class="line">	accessFlags uint16</span><br><span class="line">	name        string</span><br><span class="line">	descriptor  string</span><br><span class="line">	class       *Class // 所属的类</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 从 classFile 中复制数据</span><br><span class="line">func (self *ClassMember) copyMemberInfo(memberInfo *classfile.MemberInfo) &#123;</span><br><span class="line">	self.accessFlags = memberInfo.AccessFlags()</span><br><span class="line">	self.name = memberInfo.Name()</span><br><span class="line">	self.descriptor = memberInfo.Descriptor()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// d 是否可以访问 self(字段或方法)</span><br><span class="line">func (self *ClassMember) isAccessibleTo(d *Class) bool &#123;</span><br><span class="line">	// self 是 public</span><br><span class="line">	if self.IsPublic() &#123;</span><br><span class="line">		return true</span><br><span class="line">	&#125;</span><br><span class="line">	c := self.class</span><br><span class="line">	// self 是 protected，则只有 d 是 self所在的class c的子类或者同一个包可以访问</span><br><span class="line">	// 注意 protected 不只是子类级别，同包也可访问</span><br><span class="line">	if self.IsProtected() &#123;</span><br><span class="line">		return d == c || d.isSubClassOf(c) || c.getPackageName() == d.getPackageName()</span><br><span class="line">	&#125;</span><br><span class="line">	// self 是 default 级别</span><br><span class="line">	if !self.IsPrivate() &#123;</span><br><span class="line">		return c.getPackageName() == d.getPackageName()</span><br><span class="line">	&#125;</span><br><span class="line">	return d == c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据 classFile 创建 字段表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">type Field struct &#123;</span><br><span class="line">	ClassMember</span><br><span class="line">	constantValueIndex uint</span><br><span class="line">	slotId             uint</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 根据 classFile 创建 字段表</span><br><span class="line">func newFields(class *Class, cfFields []*classfile.MemberInfo) []*Field &#123;</span><br><span class="line">	fields := make([]*Field, len(cfFields))</span><br><span class="line">	for i, cfField := range cfFields &#123;</span><br><span class="line">		fields[i] = &amp;Field&#123;&#125;</span><br><span class="line">		fields[i].class = class</span><br><span class="line">		fields[i].copyMemberInfo(cfField)</span><br><span class="line">		fields[i].copyAttributes(cfField)</span><br><span class="line">	&#125;</span><br><span class="line">	return fields</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据 classFile 创建 方法表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">type Method struct &#123;</span><br><span class="line">	ClassMember</span><br><span class="line">	maxStack  uint</span><br><span class="line">	maxLocals uint</span><br><span class="line">	code      []byte // 方法字节码表</span><br><span class="line">	argSlotCount uint // 参数个数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func newMethods(class *Class, cfMethods []*classfile.MemberInfo) []*Method &#123;</span><br><span class="line">	methods := make([]*Method, len(cfMethods))</span><br><span class="line">	for i, cfMethod := range cfMethods &#123;</span><br><span class="line">		methods[i] = &amp;Method&#123;&#125;</span><br><span class="line">		methods[i].class = class</span><br><span class="line">		methods[i].copyMemberInfo(cfMethod)</span><br><span class="line">		methods[i].copyAttributes(cfMethod)</span><br><span class="line">		methods[i].calArgSlotCount()</span><br><span class="line">	&#125;</span><br><span class="line">	return methods</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、把-classFile-中的常量池转化为运行时常量池"><a href="#2、把-classFile-中的常量池转化为运行时常量池" class="headerlink" title="2、把 classFile 中的常量池转化为运行时常量池"></a>2、把 classFile 中的常量池转化为运行时常量池</h4><p>将[]classfile.ConstantInfo 转化为[]heap.Constant<br>取值通过常量池来获得</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// 常量项</span><br><span class="line">type Constant interface&#123;&#125;</span><br><span class="line"></span><br><span class="line">// 运行时常量池</span><br><span class="line">type ConstantPool struct &#123;</span><br><span class="line">	class  *Class // 所属的类</span><br><span class="line">	consts []Constant</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//创建运行时常量池 []consts</span><br><span class="line">func newConstantPool(class *Class, cfCp classfile.ConstantPool) *ConstantPool &#123;</span><br><span class="line">	cpCount := len(cfCp)</span><br><span class="line">	consts := make([]Constant, cpCount)</span><br><span class="line">	rtCp := &amp;ConstantPool&#123;class, consts&#125;</span><br><span class="line"></span><br><span class="line">	for i := 1; i &lt; cpCount; i++ &#123;</span><br><span class="line">		cpInfo := cfCp[i]</span><br><span class="line">		switch cpInfo.(type) &#123;</span><br><span class="line">		// 字面量：整数、浮点数、字符串</span><br><span class="line">		case *classfile.ConstantIntegerInfo:</span><br><span class="line">			consts[i] = cpInfo.(*classfile.ConstantIntegerInfo).Value()</span><br><span class="line">		case *classfile.ConstantFloatInfo:</span><br><span class="line">			consts[i] = cpInfo.(*classfile.ConstantFloatInfo).Value()</span><br><span class="line">		case *classfile.ConstantLongInfo:</span><br><span class="line">			consts[i] = cpInfo.(*classfile.ConstantLongInfo).Value()</span><br><span class="line">			i++</span><br><span class="line">		case *classfile.ConstantDoubleInfo:</span><br><span class="line">			consts[i] = cpInfo.(*classfile.ConstantDoubleInfo).Value()</span><br><span class="line">			i++</span><br><span class="line">		case *classfile.ConstantStringInfo:</span><br><span class="line">			consts[i] = cpInfo.(*classfile.ConstantStringInfo).String()</span><br><span class="line">			// 符号引用：类、字段、方法、接口方法</span><br><span class="line">		case *classfile.ConstantClassInfo:</span><br><span class="line">			classInfo := cpInfo.(*classfile.ConstantClassInfo)</span><br><span class="line">			consts[i] = newClassRef(rtCp, classInfo)</span><br><span class="line">		case *classfile.ConstantFieldrefInfo:</span><br><span class="line">			fieldrefInfo := cpInfo.(*classfile.ConstantFieldrefInfo)</span><br><span class="line">			consts[i] = newFieldRef(rtCp, fieldrefInfo)</span><br><span class="line">		case *classfile.ConstantMethodrefInfo:</span><br><span class="line">			methodrefInfo := cpInfo.(*classfile.ConstantMethodrefInfo)</span><br><span class="line">			consts[i] = newMethodRef(rtCp, methodrefInfo)</span><br><span class="line">		case *classfile.ConstantInterfaceMethodrefInfo:</span><br><span class="line">			interfaceMethodrefInfo := cpInfo.(*classfile.ConstantInterfaceMethodrefInfo)</span><br><span class="line">			consts[i] = newInterfaceMethodRef(rtCp, interfaceMethodrefInfo)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return rtCp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 根据索引返回常量项 取值</span><br><span class="line">func (self *ConstantPool) GetConstant(index uint) Constant &#123;</span><br><span class="line">	if c := self.consts[index]; c != nil &#123;</span><br><span class="line">		return c</span><br><span class="line">	&#125;</span><br><span class="line">	panic(fmt.Sprintf(&quot;No Constant at index %d&quot;, index))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类、字段、方法、接口存引用<br>字符串 存常量池索引</p>
<p>引用类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// 符号引用基类</span><br><span class="line">type SymRef struct &#123;</span><br><span class="line">	cp        *ConstantPool // 符号引用所在的常量池</span><br><span class="line">	className string        // 类的全限定名</span><br><span class="line">	class     *Class        // 符号引用所属的类</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (self *SymRef) ResolvedClass() *Class &#123;</span><br><span class="line">	if self.class == nil &#123;</span><br><span class="line">		self.resolveClassRef()</span><br><span class="line">	&#125;</span><br><span class="line">	return self.class</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (self *SymRef) resolveClassRef() &#123;</span><br><span class="line">	d := self.cp.class</span><br><span class="line">	c := d.loader.LoadClass(self.className)</span><br><span class="line">	if !c.isAccessibleTo(d) &#123;</span><br><span class="line">		panic(&quot;java.lang.IllegalAccessError&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	self.class = c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 类符号引用</span><br><span class="line">type ClassRef struct &#123;</span><br><span class="line">	SymRef</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 将 classfile.ConstantClassInfo 转化为 ClassRef</span><br><span class="line">func newClassRef(cp *ConstantPool, classInfo *classfile.ConstantClassInfo) *ClassRef &#123;</span><br><span class="line">	ref := &amp;ClassRef&#123;&#125;</span><br><span class="line">	ref.cp = cp</span><br><span class="line">	ref.className = classInfo.Name()</span><br><span class="line">	return ref</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">type MemberRef struct &#123;</span><br><span class="line">	SymRef</span><br><span class="line">	name       string</span><br><span class="line">	descriptor string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (self *MemberRef) copyMemberRefInfo(refInfo *classfile.ConstantMemberrefInfo) &#123;</span><br><span class="line">	self.className = refInfo.ClassName()</span><br><span class="line">	self.name, self.descriptor = refInfo.NameAndDescriptor()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// getter</span><br><span class="line">func (self *MemberRef) Name() string &#123;</span><br><span class="line">	return self.name</span><br><span class="line">&#125;</span><br><span class="line">func (self *MemberRef) Descriptor() string &#123;</span><br><span class="line">	return self.descriptor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实战项目地址"><a href="#实战项目地址" class="headerlink" title="实战项目地址"></a>实战项目地址</h4><p><a href="https://github.com/yinlingchaoliu/jvmgo.git" target="_blank" rel="noopener">https://github.com/yinlingchaoliu/jvmgo.git</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/32/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><span class="page-number current">33</span><a class="page-number" href="/page/34/">34</a><a class="extend next" rel="next" href="/page/34/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">CHEN TONG</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">337</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CHEN TONG</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.1"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
